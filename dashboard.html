<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Knights Reactor</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
<style>
:root{
--bg:#000;--bg2:#020202;--bg3:#0a0a0a;--panel:#050505;
--bd:rgba(255,179,0,.08);--bd2:#1a1a1a;
--amb:#ffb300;--amb2:#cc8f00;--amblo:rgba(255,179,0,.04);
--txt:#ffb300;--txtd:rgba(255,255,255,.3);--txtdd:rgba(255,255,255,.1);
--grn:#00e676;--grn2:rgba(0,230,118,.05);
--red:#ff003c;--red2:rgba(255,0,60,.05);
--blu:#00e5ff;--blu2:rgba(0,229,255,.05);
--orn:#ff6a00;--orn2:rgba(255,106,0,.05);
--wht:rgba(255,255,255,.85);
--f1:'Orbitron',monospace;--f2:'JetBrains Mono',monospace;--f3:'JetBrains Mono',monospace;
--glow-a:0 0 15px rgba(255,179,0,.25);--glow-c:0 0 12px rgba(0,229,255,.2)
}
html.light{
--bg:#f0ece2;--bg2:#e8e2d6;--bg3:#ddd6c6;--panel:#f5f1e8;
--bd:rgba(140,100,20,.2);--bd2:rgba(140,100,20,.12);
--amb:#8a6010;--amb2:#6e4c0c;--amblo:rgba(140,100,20,.06);
--txt:#8a6010;--txtd:#a08848;--txtdd:#c4b898;
--grn:#1a8a3a;--grn2:rgba(26,138,58,.08);--red:#c03020;--red2:rgba(192,48,32,.08);
--blu:#1870b0;--blu2:rgba(24,112,176,.08);--orn:#b05010;--orn2:rgba(176,80,16,.08);
--wht:#3a3428;--glow-a:none;--glow-c:none
}
html.light select.fin option{background:var(--panel);color:var(--amb)}
html.light .login-box{box-shadow:0 2px 24px rgba(0,0,0,.06)}
html.light .sb-exec{color:#fff}
*{margin:0;padding:0;box-sizing:border-box}
html{font-size:clamp(13px,1.15vw,19px)}
body{background:var(--bg);color:var(--txt);font-family:var(--f3);height:100vh;overflow:hidden}
.material-symbols-outlined{font-variation-settings:'FILL' 0,'wght' 300,'GRAD' 0,'opsz' 20;vertical-align:middle}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
#L{min-height:100vh;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at 50% 30%,rgba(255,179,0,.015),transparent 60%)}
.login-box{width:26em;padding:3em 2.2em;text-align:center;background:var(--panel);border:1px solid var(--bd2);box-shadow:var(--glow-a)}

/* ‚îÄ‚îÄ SHARED ‚îÄ‚îÄ */
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:var(--amb);box-shadow:0 0 6px var(--amb)}::-webkit-scrollbar-track{background:var(--bg)}
button{font-family:var(--f3);cursor:pointer}input,select,textarea{font-family:var(--f3)}.hd{display:none}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes scan{0%{top:-100%}100%{top:100%}}
@keyframes glow{0%,100%{box-shadow:0 0 6px rgba(255,179,0,.1)}50%{box-shadow:0 0 20px rgba(255,179,0,.2)}}

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.bg{font-family:var(--f2);font-size:.55em;padding:.2em .55em;display:inline-flex;align-items:center;gap:5px;letter-spacing:1.5px;text-transform:uppercase;font-weight:700}
.bd2{width:5px;height:5px;border-radius:50%}
.bg-g{color:var(--grn);background:var(--grn2);border:1px solid rgba(0,230,118,.1)}.bg-g .bd2{background:var(--grn)}
.bg-r{color:var(--red);background:var(--red2);border:1px solid rgba(255,0,60,.1)}.bg-r .bd2{background:var(--red)}
.bg-b{color:var(--blu);background:var(--blu2);border:1px solid rgba(0,229,255,.1)}.bg-b .bd2{background:var(--blu);animation:pulse 1.2s infinite}
.bg-m{color:var(--txtdd);background:rgba(255,255,255,.015);border:1px solid rgba(255,255,255,.05)}.bg-m .bd2{background:var(--txtdd)}
.bg-o{color:var(--amb);background:var(--amblo);border:1px solid var(--bd)}.bg-o .bd2{background:var(--amb);animation:pulse 1.5s infinite}

/* ‚îÄ‚îÄ PHASES ‚îÄ‚îÄ */
.ph{background:var(--panel);border:1px solid var(--bd2);padding:.85em 1.1em;border-left:3px solid rgba(255,255,255,.05);transition:all .3s;position:relative;overflow:hidden;margin-bottom:2px}
.ph.dn{border-left-color:var(--grn);background:rgba(0,230,118,.015)}.ph.rn{border-left-color:var(--blu);background:rgba(0,229,255,.015)}
.ph.rn::after{content:'';position:absolute;top:0;left:0;width:100%;height:2px;background:linear-gradient(90deg,transparent,var(--blu),transparent);animation:scan 2s linear infinite}
.ph.dm{opacity:.18}.ph.gt{border-left-color:var(--amb);background:var(--amblo)}

/* ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ */
.sec{background:var(--panel);border:1px solid var(--bd2);margin-bottom:.6em}
.sec-h{width:100%;display:flex;align-items:center;justify-content:space-between;padding:1.1em 1.4em;background:none;border:none;color:var(--txt);cursor:pointer;transition:background .15s}
.sec-h:hover{background:rgba(255,179,0,.02)}
.sec-t{font-family:var(--f1);font-size:.7em;font-weight:700;letter-spacing:.2em}.sec-a{font-size:1em;color:var(--txtd);transition:transform .15s}
.sec-b{padding:0 1.4em 1em}.sec-b.shut{display:none}
.fi{padding:.75em 0;border-bottom:1px solid var(--bd2)}
.fl{font-size:.6em;color:var(--txtd);text-transform:uppercase;letter-spacing:.2em;margin-bottom:.4em;font-weight:500}
.fin{width:100%;padding:.7em .9em;background:var(--bg);border:1px solid var(--bd2);font-size:.85em;color:var(--amb);outline:none;font-family:var(--f3);border-radius:0;transition:border-color .15s}
.fin:focus{border-color:var(--amb);box-shadow:0 0 8px rgba(255,179,0,.06)}
select.fin{-webkit-appearance:none;-moz-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23ffb300'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;background-color:var(--bg);padding-right:30px;cursor:pointer}
html.light select.fin{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238a6010'/%3E%3C/svg%3E")}
select.fin option{background:var(--bg2);color:var(--amb);padding:6px}
.fin-slider{-webkit-appearance:none;appearance:none;background:var(--bg3);border-radius:0;outline:none;height:.35em;cursor:pointer;width:100%}
.fin-slider::-webkit-slider-thumb{-webkit-appearance:none;width:1.2em;height:1.2em;border-radius:0;background:var(--amb);border:2px solid var(--bg);cursor:pointer;box-shadow:var(--glow-a)}
.fin-slider::-moz-range-thumb{width:1.2em;height:1.2em;border-radius:0;background:var(--amb);border:2px solid var(--bg)}
.tg{width:3em;height:1.5em;border-radius:0;border:1px solid var(--bd2);position:relative;transition:all .2s}
.tg.on{background:rgba(0,230,118,.1);border-color:var(--grn)}.tg.off{background:var(--bg);border-color:var(--bd2)}
.td{position:absolute;top:.15em;width:1.15em;height:1.15em;background:var(--amb);transition:left .2s;left:.15em}.tg.on .td{background:var(--grn);left:1.5em}.tg.off .td{left:.15em}
.sv{width:100%;padding:1em;border:1px solid var(--amb);background:rgba(255,179,0,.03);font-size:.7em;font-weight:700;color:var(--amb);letter-spacing:.25em;font-family:var(--f1);margin-top:1em;transition:all .15s}.sv:hover{background:rgba(255,179,0,.08);box-shadow:var(--glow-a)}
.btn-upload{padding:.4em .7em;background:rgba(255,179,0,.04);border:1px solid var(--bd2);color:var(--amb);font-size:.85em;cursor:pointer;white-space:nowrap;font-family:var(--f3);min-width:2.5em;text-align:center;transition:background .15s}.btn-upload:hover{background:rgba(255,179,0,.1)}.btn-upload.uploading{opacity:.5;pointer-events:none}
.sm{background:var(--grn2);border:1px solid rgba(0,230,118,.1);padding:.5em .9em;margin-bottom:.55em;font-size:.65em;color:var(--grn);font-weight:500}
.rw{padding:.85em 1.2em;border-bottom:1px solid var(--bd2);transition:background .15s}.rw:hover{background:rgba(255,179,0,.015)}
.panel{background:var(--panel);border:1px solid var(--bd2);padding:1.2em;position:relative;overflow:hidden}
.ptitle{font-family:var(--f1);font-size:.55em;font-weight:700;letter-spacing:.2em;color:var(--txtd);margin-bottom:.6em;display:flex;align-items:center;gap:.6em;text-transform:uppercase}
.ptitle::before{content:'';width:3px;height:.8em;background:var(--amb);box-shadow:var(--glow-a)}
.stat{background:var(--panel);border:1px solid var(--bd2);padding:.85em;text-align:center}
.stat b{font-family:var(--f1);font-size:1.3em;font-weight:900;display:block}
.stat small{font-family:var(--f1);font-size:.45em;letter-spacing:.2em;color:var(--txtd);font-weight:700}
.pgrid{display:grid;gap:6px;margin:8px 0}.pcard{background:var(--bg);border:1px solid var(--bd2);overflow:hidden;position:relative}
.pcard img,.pcard video{width:100%;height:auto;display:block}
.pcard .dl{position:absolute;bottom:3px;right:3px;background:rgba(0,0,0,.9);border:1px solid var(--bd2);color:var(--amb);font-size:.5em;padding:.15em .4em;cursor:pointer}
.plbl{font-size:.45em;color:var(--txtd);padding:.3em .5em;letter-spacing:.12em;text-transform:uppercase;font-weight:700}
.fvid{border:1px solid var(--amb);padding:2px;background:var(--bg);margin:8px 0}.fvid video{width:100%;display:block}
.gate-banner{display:flex;align-items:center;gap:1em;padding:1em 1.2em;border:1px solid var(--amb);background:rgba(255,179,0,.02);margin-bottom:10px}
.g-icon{font-size:1.2em;color:var(--amb)}.g-text{flex:1}.g-title{font-family:var(--f1);font-size:.65em;font-weight:700;color:var(--amb);letter-spacing:.15em}.g-sub{font-size:.6em;color:var(--txtd);margin-top:.15em}
.btn-sm{padding:.5em .9em;font-family:var(--f1);font-size:.55em;font-weight:700;letter-spacing:.1em;border:1px solid var(--bd2);background:none;cursor:pointer;transition:all .15s;color:var(--txtd)}
.btn-sm:hover{color:var(--amb);border-color:var(--bd)}
.btn-sm.btn-blu{color:var(--blu);border-color:rgba(0,229,255,.15)}.btn-sm.btn-blu:hover{background:rgba(0,229,255,.04)}
.btn-sm.btn-grn{color:var(--grn);border-color:rgba(0,230,118,.15)}.btn-sm.btn-grn:hover{background:rgba(0,230,118,.04)}
.btn-sm.btn-red{color:var(--red);border-color:rgba(255,0,60,.15)}.btn-sm.btn-red:hover{background:rgba(255,0,60,.04)}

/* ‚îÄ‚îÄ LOGS ‚îÄ‚îÄ */
.logp{background:var(--panel);border:1px solid var(--bd2);padding:0;max-height:calc(100vh - 10em);overflow-y:auto;font-size:.7em;line-height:1}
.log-row{display:flex;gap:0;padding:.55em .8em;border-left:2px solid transparent;transition:background .12s;align-items:baseline}
.log-row:hover{background:rgba(255,179,0,.015)}
.log-row.lv-ok{border-left-color:var(--grn)}.log-row.lv-error{border-left-color:var(--red);background:rgba(255,0,60,.02)}.log-row.lv-info{border-left-color:transparent}
.log-ts{width:5.5em;flex-shrink:0;color:rgba(255,255,255,.15);font-weight:500}
.log-lv{width:4em;flex-shrink:0;font-weight:900;letter-spacing:1.5px;font-size:.85em}
.log-lv.ok{color:var(--grn)}.log-lv.error{color:var(--red)}.log-lv.info{color:var(--blu)}
.log-ph{width:8em;flex-shrink:0;font-weight:700;color:rgba(255,255,255,.25);font-size:.85em;text-transform:uppercase;letter-spacing:.5px}
.log-msg{flex:1;color:rgba(255,255,255,.7);line-height:1.5}
.log-msg.lv-error{color:#fff;font-weight:700}

/* ‚ïê‚ïê DESKTOP ‚ïê‚ïê */
@media(min-width:769px){
.mob-wrap{display:none!important}
.desk-wrap{display:flex!important;height:100vh}
.sidebar{width:15em;background:var(--bg2);border-right:1px solid var(--bd2);display:flex;flex-direction:column;flex-shrink:0}
.sb-logo{padding:1.4em 1.3em;border-bottom:1px solid var(--bd2)}
.sb-logo h1{font-family:var(--f1);font-size:.7em;font-weight:900;color:var(--amb);letter-spacing:.15em;line-height:1.5;text-shadow:0 0 12px rgba(255,179,0,.3)}
.sb-logo p{font-size:.45em;color:var(--blu);letter-spacing:.25em;margin-top:.3em;opacity:.55}
.sb-nav{flex:1;padding:10px 0;overflow-y:auto}
.sb-i{width:100%;display:flex;align-items:center;gap:.75em;padding:.7em 1.3em;background:none;border:none;border-right:2px solid transparent;color:rgba(255,255,255,.3);font-size:.65em;letter-spacing:.15em;transition:all .12s;text-align:left;font-weight:500;text-transform:uppercase}
.sb-i:hover{color:var(--amb);background:rgba(255,179,0,.02)}
.sb-i.on{color:var(--amb);border-right-color:var(--amb);background:rgba(255,179,0,.04);text-shadow:0 0 8px rgba(255,179,0,.4);box-shadow:inset 0 0 12px rgba(255,179,0,.03);font-weight:700}
.sb-i .material-symbols-outlined{font-size:1.15em;opacity:.5}.sb-i.on .material-symbols-outlined{opacity:1}
.sb-i span:not(.material-symbols-outlined){font-size:.85em;width:1.15em;text-align:center;opacity:.5}.sb-i.on span:not(.material-symbols-outlined){opacity:1}
.sb-ft{padding:.8em 1.2em;border-top:1px solid var(--bd2);background:var(--bg)}
.sb-exec{width:100%;padding:.75em;font-family:var(--f1);font-size:.6em;font-weight:700;letter-spacing:.2em;color:#000;background:var(--amb);border:none;box-shadow:0 0 16px rgba(255,179,0,.2);transition:all .12s}
.sb-exec:hover{box-shadow:0 0 28px rgba(255,179,0,.35);filter:brightness(1.08)}
.sb-exec:active{transform:scale(.98)}
.sb-res{width:100%;padding:.5em;font-family:var(--f1);font-size:.5em;letter-spacing:.15em;color:var(--amb);background:none;border:1px solid var(--bd2);margin-top:5px;display:none;transition:all .15s}.sb-res:hover{border-color:var(--amb)}
.dmain{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{height:3em;background:var(--bg2);border-bottom:1px solid var(--bd2);display:flex;align-items:center;justify-content:space-between;padding:0 1.5em;flex-shrink:0}
.topbar-t{font-family:var(--f1);font-size:.6em;letter-spacing:.25em;color:var(--txtd);font-weight:500}
.topbar-s{display:flex;align-items:center;gap:12px}
.topbar-ph{font-size:.6em;color:var(--blu);letter-spacing:.1em;font-weight:500}
.topbar-pb{width:8em;height:3px;background:var(--bg3);overflow:hidden}
.topbar-pb div{height:100%;background:var(--amb);box-shadow:var(--glow-a);transition:width .6s}
.dcontent{flex:1;overflow-y:auto;padding:1.4em}
.dpage{display:none}.dpage.on{display:block}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:.7em}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.7em}
.g4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:.5em}
.phgrid{display:grid;grid-template-columns:1fr 1fr;gap:2px}
.sec-b{display:grid;grid-template-columns:1fr 1fr;gap:.2em 1.5em}
.fi.w{grid-column:1/-1}
.pgrid{grid-template-columns:repeat(4,1fr)}
.man-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.man-card{background:var(--panel);border:1px solid var(--bd2);overflow:hidden}
.man-card-preview{aspect-ratio:9/16;background:var(--bg);position:relative;overflow:hidden;max-height:14em}
.man-card-preview video{width:100%;height:100%;object-fit:cover;display:block}
.man-card-preview audio{width:100%;position:absolute;bottom:0;left:0}
.man-card-empty{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.3em;color:var(--txtdd);font-size:.6em;cursor:pointer;border:2px dashed var(--bd2)}
.man-card-bar{display:flex;gap:3px;padding:4px;align-items:center;background:var(--bg2)}
.man-card-bar .fin{border:none;background:transparent;padding:.3em .4em;font-size:.7em}
.man-card-badge{position:absolute;top:3px;right:3px;background:rgba(0,0,0,.9);border:1px solid var(--bd2);color:var(--grn);font-family:var(--f1);font-size:.5em;padding:.1em .3em}
.man-card-num{position:absolute;top:3px;left:3px;background:rgba(0,0,0,.9);border:1px solid var(--bd2);color:var(--amb);font-family:var(--f1);font-size:.45em;padding:.1em .3em}
.man-card-rm{position:absolute;bottom:3px;right:3px;background:rgba(255,0,60,.08);border:1px solid rgba(255,0,60,.15);color:var(--red);font-size:.5em;padding:.1em .3em;cursor:pointer}
.man-vo-card .man-card-preview{aspect-ratio:auto;min-height:3em;max-height:4em}
}

/* ‚ïê‚ïê MOBILE ‚ïê‚ïê */
@media(max-width:768px){
.desk-wrap{display:none!important}
.mob-wrap{display:block!important}
body{overflow:auto}
.mhdr{padding:14px;border-bottom:1px solid var(--bd2);background:var(--bg2);display:flex;align-items:center;justify-content:space-between}
.mhdr h1{font-family:var(--f1);font-size:.7em;font-weight:900;color:var(--amb);letter-spacing:.15em;text-shadow:0 0 8px rgba(255,179,0,.3)}
.mexec{font-family:var(--f1);font-size:.55em;font-weight:700;color:#000;background:var(--amb);border:none;padding:.7em 1em;letter-spacing:.15em}
.mres{font-family:var(--f1);font-size:.55em;color:var(--amb);background:none;border:1px solid var(--amb);padding:.7em;letter-spacing:.15em;display:none;margin-left:.35em}
.mprog{height:3px;background:var(--bd2);overflow:hidden}.mprog div{height:100%;background:var(--amb);box-shadow:var(--glow-a);transition:width .6s}
.mtabs{display:flex;border-bottom:1px solid var(--bd2);background:var(--bg2);overflow-x:auto;-webkit-overflow-scrolling:touch}
.mt{font-family:var(--f1);font-size:.5em;color:rgba(255,255,255,.3);background:none;border:none;border-bottom:2px solid transparent;padding:.8em .7em;white-space:nowrap;letter-spacing:1.5px;min-height:3em;font-weight:500;transition:all .12s}
.mt:hover{color:var(--amb)}.mt.on{color:var(--amb);font-weight:700;border-bottom-color:var(--amb);text-shadow:0 0 8px rgba(255,179,0,.3)}
.mcont{padding:12px}
.mpage{display:none}.mpage.on{display:block}
.g4m{display:grid;grid-template-columns:1fr 1fr;gap:.3em;margin-bottom:.55em}
.sec-b{display:block}
.fin{font-size:1em;padding:.75em .9em;min-height:3em}
.tg{width:3.4em;height:1.85em}.td{top:.2em;width:1.4em;height:1.4em}
.tg.on .td{left:1.7em!important}.tg.off .td{left:.2em!important}
.sec-h{min-height:3.2em}
.pgrid{grid-template-columns:repeat(2,1fr)}
.logp{max-height:28em;overflow-y:auto;padding:0}
.man-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
.man-card-preview{max-height:12em}
.log-row{padding:.5em .6em;font-size:.85em}
.log-ts{width:4.5em;font-size:.85em}.log-lv{width:3.5em}.log-ph{width:6em;font-size:.8em}
}
</style></head><body>

<div id="L"><div class="login-box">
<div style="font-family:var(--f1);font-size:.45em;color:var(--txtd);letter-spacing:6px;margin-bottom:8px">SYSTEM ACCESS</div>
<div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:4px"><div style="width:3px;height:1.2em;background:var(--amb);box-shadow:var(--glow-a)"></div><span style="font-family:var(--f1);font-size:1.15em;font-weight:900;color:var(--amb);letter-spacing:3px" id="login-title">CONTENT REACTOR</span></div>
<div style="font-size:.5em;color:var(--blu);letter-spacing:.3em;margin-bottom:1.6em;opacity:.55">/// PIPELINE CONTROL v9.4 ///</div>
<div style="width:3em;height:2px;background:var(--amb);margin:0 auto 1.3em;box-shadow:var(--glow-a)"></div>
<input type="password" id="pw" style="width:100%;padding:.75em;background:var(--bg);border:1px solid var(--bd2);font-size:.85em;color:var(--amb);outline:none;margin-bottom:.6em;text-align:center;letter-spacing:3px;font-family:var(--f3)" placeholder="ACCESS CODE" onkeydown="event.key==='Enter'&&go()">
<div id="le" class="hd" style="font-size:.6em;color:var(--red);margin-bottom:.4em;font-weight:700;letter-spacing:1px">ACCESS DENIED</div>
<button onclick="go()" style="width:100%;padding:12px;border:1px solid var(--amb);background:rgba(255,179,0,.03);font-family:var(--f1);font-size:.6em;font-weight:700;color:var(--amb);letter-spacing:.25em;transition:all .15s" onmouseover="this.style.background='rgba(255,179,0,.08)'" onmouseout="this.style.background='rgba(255,179,0,.03)'">AUTHENTICATE</button>
</div></div>

<div id="A" class="hd">
<!-- ‚ïê‚ïê‚ïê DESKTOP ‚ïê‚ïê‚ïê -->
<div class="desk-wrap">
<div class="sidebar">
<div class="sb-logo"><h1 id="d-brand-title">KNIGHTS<br>REACTOR</h1><p>PIPELINE CONTROL v9.4</p>
<select id="d-brand-sel" class="fin" style="margin-top:8px;font-size:.6em;padding:.4em;width:100%" onchange="switchBrand(this.value)"></select>
<button id="d-brand-del" onclick="deleteBrand()" style="width:100%;margin-top:4px;padding:.35em;font-family:var(--f1);font-size:.45em;letter-spacing:.12em;color:var(--red);background:var(--red2);border:1px solid rgba(255,0,60,.1);display:none;cursor:pointer">‚úï DELETE BRAND</button>
</div>
<div class="sb-nav">
<button class="sb-i on" onclick="dNav('pipeline',this)"><span class="material-symbols-outlined">bolt</span>PIPELINE</button>
<button class="sb-i" onclick="dNav('manual',this)"><span class="material-symbols-outlined">terminal</span>MANUAL</button>
<button class="sb-i" onclick="dNav('topics',this)"><span class="material-symbols-outlined">data_object</span>TOPICS</button>
<button class="sb-i" onclick="dNav('runs',this)"><span class="material-symbols-outlined">history</span>RUNS</button>
<button class="sb-i" onclick="dNav('logs',this)"><span class="material-symbols-outlined">list_alt</span>LOGS</button>
<button class="sb-i" onclick="dNav('preview',this)"><span class="material-symbols-outlined">monitoring</span>PREVIEW</button>
<button class="sb-i" onclick="dNav('settings',this)"><span class="material-symbols-outlined">settings_input_component</span>CONFIG</button>
<button class="sb-i" onclick="dNav('health',this)"><span class="material-symbols-outlined">query_stats</span>STATUS</button>
<button class="sb-i" onclick="dNav('channels',this)"><span class="material-symbols-outlined">cell_tower</span>CHANNELS</button>
</div>
<div class="sb-ft">
<button class="sb-exec" id="d-rb" onclick="runNow()">‚ñ∂ EXECUTE</button>
<button class="sb-res" id="d-rsb" onclick="resumeNow()">‚ôª RESUME</button>
<button id="d-thm" onclick="toggleTheme()" style="width:100%;padding:6px;margin-top:6px;font-size:.5em;letter-spacing:.15em;color:var(--txtd);background:none;border:1px solid var(--bd2);font-family:var(--f1);transition:all .15s">‚òÄ LIGHT MODE</button>
</div>
</div>
<div class="dmain">
<div class="topbar"><div class="topbar-t" id="d-title">‚ö° PIPELINE MONITOR</div><div class="topbar-s"><span class="topbar-ph" id="d-ph"></span><div class="topbar-pb"><div id="d-pb"></div></div></div></div>
<div class="dcontent">

<div class="dpage on" id="dp-pipeline">
<div style="display:flex;gap:6px;margin-bottom:10px">
<button id="d-rb2" onclick="runNow()" style="flex:1;padding:.75em;background:var(--amb);border:none;color:#000;font-family:var(--f1);font-size:.6em;font-weight:700;letter-spacing:.2em;box-shadow:0 0 12px rgba(255,179,0,.2);transition:all .12s">‚ñ∂ EXECUTE</button>
<button onclick="scriptOnly()" style="flex:1;padding:.75em;background:rgba(0,229,255,.04);border:1px solid rgba(0,229,255,.12);color:var(--blu);font-family:var(--f1);font-size:.6em;font-weight:700;letter-spacing:.15em;transition:all .12s">‚úé SCRIPT ONLY</button>
<button class="sb-res" id="d-rsb2" onclick="resumeNow()" style="flex:1;padding:.75em;font-family:var(--f1);font-size:.6em;letter-spacing:.15em;color:var(--amb);background:none;border:1px solid var(--bd2);display:none">‚ôª RESUME</button>
</div>
<div id="d-gate"></div>
<div class="g4" id="d-stats" style="margin-bottom:12px"></div>
<div id="d-script-result" class="hd" style="background:var(--panel);border:1px solid var(--bd2);padding:1.2em;margin-bottom:6px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5em"><span style="font-family:var(--f1);font-size:.6em;color:var(--amb);letter-spacing:.15em" id="d-scr-title"></span><button onclick="$('d-script-result').classList.add('hd')" style="background:none;border:none;color:var(--txtd);font-size:.8em;cursor:pointer">‚úï</button></div>
<div id="d-scr-text" style="font-size:.8em;color:var(--wht);line-height:1.8;margin-bottom:.7em"></div>
<div id="d-scr-meta" style="font-size:.6em;color:var(--txtd);margin-bottom:.7em"></div>
<div id="d-scr-prompts"></div>
</div>
<div class="phgrid" id="d-pl"></div>
</div>

<div class="dpage" id="dp-manual">
<div style="display:flex;gap:6px;margin-bottom:12px">
<button id="d-man-run" onclick="manualRun()" style="flex:1;padding:.8em;background:rgba(0,230,118,.06);border:1px solid rgba(0,230,118,.15);color:var(--grn);font-family:var(--f1);font-size:.65em;font-weight:700;letter-spacing:.15em;transition:all .12s">‚óà EXECUTE MANUAL RUN</button>
</div>
<div id="d-mtotals" style="display:none;margin-bottom:10px;padding:8px 12px;background:rgba(255,179,0,.02);border:1px solid var(--bd2);font-family:var(--f1);font-size:.6em;color:var(--amb);letter-spacing:.1em;justify-content:space-between"><span id="d-mt-clips"></span><span id="d-mt-vo" style="color:var(--blu)"></span><span id="d-mt-total" style="color:var(--grn)"></span></div>
<div style="font-family:var(--f1);font-size:.55em;color:var(--txtd);letter-spacing:.2em;margin-bottom:6px">VIDEO CLIPS</div>
<div id="d-mclips" class="man-grid"></div>
<button onclick="addClipCard('d')" style="width:100%;padding:8px;background:var(--bg);border:1px dashed var(--bd2);color:var(--txtd);font-family:var(--f1);font-size:.55em;letter-spacing:.15em;margin:6px 0 16px;transition:all .12s">+ ADD CLIP</button>
<div style="font-family:var(--f1);font-size:.55em;color:var(--txtd);letter-spacing:.2em;margin-bottom:6px">VOICEOVER (OPTIONAL)</div>
<div class="man-card man-vo-card" id="d-vo-card">
<div class="man-card-preview" id="d-vo-preview"><div class="man-card-empty" onclick="document.querySelector('#d-vo-card .man-url').focus()"><span style="font-size:1.5em">‚óé</span><span>Paste URL or upload audio</span></div></div>
<div class="man-card-bar"><input class="fin man-url mc-vo" placeholder="Audio URL (mp3/wav/m4a)" style="flex:1;font-size:.8em" onchange="probeVo(this);renderVoCard('d')" onpaste="setTimeout(()=>{probeVo(this);renderVoCard('d')},100)"><span class="vo-dur" style="font-family:var(--f1);font-size:.6em;color:var(--txtd);min-width:3em;text-align:right"></span><button class="btn-upload" onclick="uploadFile(this,'audio')">‚ñ§</button></div>
</div>
<div style="font-size:.5em;color:var(--txtdd);margin:4px 0 16px">With voiceover: skips ALL AI generation. Whisper transcribes ‚Üí GPT generates captions. (~$0.02)</div>
<div style="font-family:var(--f1);font-size:.55em;color:var(--txtd);letter-spacing:.2em;margin-bottom:6px">CTA CLIP (OPTIONAL)</div>
<div class="man-card" id="d-cta-card" style="max-width:50%">
<div class="man-card-preview" id="d-cta-preview"><div class="man-card-empty" onclick="document.querySelector('#d-cta-card .man-url').focus()"><span style="font-size:1.5em">‚ñ∂</span><span>End card</span></div></div>
<div class="man-card-bar"><input class="fin man-url mc-cta" placeholder="CTA clip URL" style="flex:1;font-size:.8em" onchange="renderCtaCard('d')" onpaste="setTimeout(()=>renderCtaCard('d'),100)"><button class="btn-upload" onclick="uploadFile(this,'video')">‚ñ§</button></div>
</div>
<div style="font-size:.5em;color:var(--txtdd);margin-top:4px">Leave empty to use default from settings.</div>
</div>

<div class="dpage" id="dp-topics">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.7em">
<span class="ptitle" style="margin:0">TOPIC DATABASE</span>
<div style="display:flex;gap:6px">
<button class="btn-sm" onclick="seedTopics()">SEED DEFAULTS</button>
<button class="btn-sm btn-blu" onclick="generateTopicsAI()">‚ú¶ AI GENERATE</button>
</div>
</div>
<div class="panel" style="padding:.5em;margin-bottom:.7em">
<div style="display:flex;gap:6px">
<input class="fin" id="d-ti" placeholder="New topic idea..." style="flex:1">
<select class="fin" id="d-tc" style="width:10em"><option>Shocking Revelations</option><option>Shocking Reveal</option><option>Behind-the-Scenes</option><option>Myths Debunked</option><option>Deep Dive Analysis</option></select>
<input class="fin" id="d-ts" placeholder="Scripture ref..." style="width:8em">
<button class="btn-sm btn-grn" onclick="addNewTopic()">+ ADD</button>
</div>
</div>
<div class="panel" id="d-tl" style="padding:0;max-height:calc(100vh - 16em);overflow-y:auto"></div>
</div>

<div class="dpage" id="dp-runs"><div class="g4" id="d-rs" style="margin-bottom:12px"></div><div class="panel" id="d-rl"></div></div>

<div class="dpage" id="dp-logs">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<span class="ptitle" style="margin:0">EXECUTION STREAM</span>
<span id="d-lc" style="font-size:.6em;color:var(--txtd);letter-spacing:1px"></span>
</div>
<div class="logp" id="d-la"></div>
</div>

<div class="dpage" id="dp-preview">
<div id="d-pve" class="panel" style="padding:2.5em;text-align:center"><div style="font-size:.65em;color:var(--txtd);letter-spacing:.2em">NO ASSETS YET</div><div style="font-size:.55em;color:var(--txtdd);margin-top:.4em">Execute pipeline to generate media</div></div>
<div id="d-pvi" class="hd"><div class="ptitle">IMAGES</div><div id="d-pig" class="pgrid"></div></div>
<div id="d-pvv" class="hd"><div class="ptitle" style="margin-top:12px">CLIPS</div><div id="d-pvg" class="pgrid"></div></div>
<div id="d-pvf" class="hd"><div class="ptitle" style="margin-top:12px;color:var(--grn)">FINAL RENDER</div><div class="fvid"><video id="d-fv" controls></video></div><a id="d-fd" href="#" download style="display:block;text-align:center;padding:8px;border:1px solid var(--amb);background:var(--amblo);color:var(--amb);font-family:var(--f1);font-size:.55em;letter-spacing:.2em;text-decoration:none;margin-top:.3em;transition:all .12s">‚¨á DOWNLOAD</a></div>
<div id="d-pvs" class="hd" style="margin-top:12px"><div class="ptitle">SCRIPT</div><div id="d-pst" class="panel" style="font-size:.8em;color:var(--wht);line-height:1.8"></div></div>
</div>

<div class="dpage" id="dp-settings"><div id="d-ss" class="sm hd">‚úì SAVED</div><div id="d-sf"></div><button class="sv" onclick="saveSett()">SAVE CONFIGURATION</button></div>

<div class="dpage" id="dp-health">
<div class="panel" id="d-hl" style="margin-bottom:10px"></div>
<div class="panel" style="padding:12px"><div class="ptitle">DIAGNOSTICS</div><button style="width:100%;padding:10px;background:var(--bg);border:1px solid var(--bd2);color:var(--amb);font-size:.75em;letter-spacing:.1em;transition:all .12s" onclick="testAll()">TEST ALL CONNECTIONS ‚Üí</button></div>
<button onclick="sessionStorage.removeItem('kt');$('L').style.display='flex';$('A').classList.add('hd')" style="width:100%;padding:9px;margin-top:10px;border:1px solid rgba(255,0,60,.12);background:var(--red2);font-family:var(--f1);font-size:.55em;color:var(--red);letter-spacing:.2em;transition:all .12s">‚ö† DISCONNECT</button>
</div>

<div class="dpage" id="dp-channels">
<div class="panel" style="margin-bottom:10px">
<div class="ptitle">BLOTATO PUBLISHING CHANNELS</div>
<div style="font-size:.6em;color:var(--txtdd);margin-bottom:1em;line-height:1.6">Configure Blotato account IDs for the current brand. Find IDs in your <a href="https://my.blotato.com/settings" target="_blank" style="color:var(--amb)">Blotato dashboard</a> under each connected account.</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:.4em 1.2em">
<div class="fi"><div class="fl">INSTAGRAM ID</div><input class="fin" id="ch-instagram" placeholder="e.g. 31177"></div>
<div class="fi"><div class="fl">FACEBOOK ID</div><input class="fin" id="ch-facebook" placeholder=""></div>
<div class="fi"><div class="fl">FACEBOOK PAGE ID</div><input class="fin" id="ch-facebook-page" placeholder=""></div>
<div class="fi"><div class="fl">X / TWITTER ID</div><input class="fin" id="ch-twitter" placeholder=""></div>
<div class="fi"><div class="fl">THREADS ID</div><input class="fin" id="ch-threads" placeholder=""></div>
<div class="fi"><div class="fl">TIKTOK ID</div><input class="fin" id="ch-tiktok" placeholder=""></div>
<div class="fi"><div class="fl">YOUTUBE ID</div><input class="fin" id="ch-youtube" placeholder=""></div>
<div class="fi"><div class="fl">PINTEREST ID</div><input class="fin" id="ch-pinterest" placeholder=""></div>
<div class="fi" style="grid-column:1/-1"><div class="fl">PINTEREST BOARD ID</div><input class="fin" id="ch-pinterest-board" placeholder=""></div>
</div>
<div style="display:flex;gap:8px;margin-top:1em">
<button class="sv" onclick="saveChannels()" style="flex:1">SAVE CHANNELS</button>
<button style="padding:.9em 1.5em;border:1px solid var(--bd2);background:var(--amblo);color:var(--amb);font-family:var(--f1);font-size:.65em;letter-spacing:.15em;transition:all .12s" onclick="loadChannels()">‚Üª RELOAD</button>
</div>
<div id="ch-status" style="font-size:.6em;color:var(--txtd);margin-top:.5em"></div>
</div>
</div>

</div></div></div>

<!-- ‚ïê‚ïê‚ïê MOBILE ‚ïê‚ïê‚ïê -->
<div class="mob-wrap">
<div class="mhdr"><div><h1 id="m-brand-title">KNIGHTS REACTOR</h1><select id="m-brand-sel" class="fin" style="font-size:.5em;padding:.3em;margin-top:2px;width:100%;border:1px solid var(--bd2)" onchange="switchBrand(this.value)"></select><button id="m-brand-del" onclick="deleteBrand()" style="width:100%;margin-top:3px;padding:.4em;font-family:var(--f1);font-size:.5em;color:var(--red);background:var(--red2);border:1px solid rgba(255,0,60,.1);display:none">‚úï DELETE</button></div><div style="display:flex;align-items:center;gap:6px"><button class="mexec" id="m-rb" onclick="runNow()">‚ñ∂ EXECUTE</button><button class="mres" id="m-rsb" onclick="resumeNow()">‚ôª</button></div></div>
<div class="mprog" id="m-prog"><div id="m-pb"></div></div>
<div class="mtabs">
<button class="mt on" onclick="mNav('pipeline',this)">‚ö° PIPELINE</button>
<button class="mt" onclick="mNav('manual',this)">‚óà MANUAL</button>
<button class="mt" onclick="mNav('topics',this)">‚ú¶ TOPICS</button>
<button class="mt" onclick="mNav('runs',this)">‚óà RUNS</button>
<button class="mt" onclick="mNav('logs',this)">‚ñ§ LOGS</button>
<button class="mt" onclick="mNav('preview',this)">‚óâ PREVIEW</button>
<button class="mt" onclick="mNav('settings',this)">‚öô CONFIG</button>
<button class="mt" onclick="mNav('health',this)">‚óé STATUS</button>
<button class="mt" onclick="mNav('channels',this)">üì° CHANNELS</button>
</div>
<div class="mcont">

<div class="mpage on" id="mp-pipeline">
<div style="display:flex;gap:5px;margin-bottom:8px">
<button id="m-rb2" onclick="runNow()" style="flex:1;padding:.7em;background:var(--amb);border:none;color:#000;font-family:var(--f1);font-size:.55em;font-weight:700;letter-spacing:.1em;min-height:2.8em">‚ñ∂ EXECUTE</button>
<button onclick="scriptOnly()" style="flex:1;padding:.7em;background:rgba(0,229,255,.04);border:1px solid rgba(0,229,255,.12);color:var(--blu);font-family:var(--f1);font-size:.55em;font-weight:700;letter-spacing:.1em;min-height:2.8em">‚úé SCRIPT</button>
</div>
<div id="m-gate"></div>
<div id="m-script-result" class="hd" style="background:var(--panel);border:1px solid var(--bd2);padding:.7em;margin-bottom:6px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.4em"><span style="font-family:var(--f1);font-size:.55em;color:var(--amb);letter-spacing:.12em" id="m-scr-title"></span><button onclick="$('m-script-result').classList.add('hd')" style="background:none;border:none;color:var(--txtd);font-size:.8em">‚úï</button></div>
<div id="m-scr-text" style="font-size:.8em;color:var(--wht);line-height:1.7;margin-bottom:.5em"></div>
<div id="m-scr-meta" style="font-size:.55em;color:var(--txtd);margin-bottom:.5em"></div>
<div id="m-scr-prompts"></div>
</div>
<div id="m-pl"></div></div>

<div class="mpage" id="mp-manual">
<div style="margin-bottom:8px">
<button onclick="manualRun()" style="width:100%;padding:.8em;background:rgba(0,230,118,.06);border:1px solid rgba(0,230,118,.15);color:var(--grn);font-family:var(--f1);font-size:.6em;font-weight:700;letter-spacing:.12em;min-height:2.8em">‚óà EXECUTE MANUAL RUN</button>
</div>
<div id="m-mtotals" style="display:none;margin-bottom:8px;padding:6px 8px;background:rgba(255,179,0,.02);border:1px solid var(--bd2);font-family:var(--f1);font-size:.55em;color:var(--amb);letter-spacing:.1em;justify-content:space-between"><span id="m-mt-clips"></span><span id="m-mt-vo" style="color:var(--blu)"></span><span id="m-mt-total" style="color:var(--grn)"></span></div>
<div style="font-family:var(--f1);font-size:.5em;color:var(--txtd);letter-spacing:.15em;margin-bottom:4px">VIDEO CLIPS</div>
<div id="m-mclips" class="man-grid"></div>
<button onclick="addClipCard('m')" style="width:100%;padding:8px;background:var(--bg);border:1px dashed var(--bd2);color:var(--txtd);font-family:var(--f1);font-size:.5em;letter-spacing:.12em;margin:4px 0 12px">+ ADD CLIP</button>
<div style="font-family:var(--f1);font-size:.5em;color:var(--txtd);letter-spacing:.15em;margin-bottom:4px">VOICEOVER (OPTIONAL)</div>
<div class="man-card man-vo-card" id="m-vo-card">
<div class="man-card-preview" id="m-vo-preview"><div class="man-card-empty" onclick="document.querySelector('#m-vo-card .man-url').focus()"><span style="font-size:1.5em">‚óé</span><span>Paste URL or upload audio</span></div></div>
<div class="man-card-bar"><input class="fin man-url mc-vo" placeholder="Audio URL" style="flex:1;font-size:.85em" onchange="probeVo(this);renderVoCard('m')" onpaste="setTimeout(()=>{probeVo(this);renderVoCard('m')},100)"><span class="vo-dur" style="font-family:var(--f1);font-size:.6em;color:var(--txtd);min-width:3em;text-align:right"></span><button class="btn-upload" onclick="uploadFile(this,'audio')">‚ñ§</button></div>
</div>
<div style="font-size:.45em;color:var(--txtdd);margin:3px 0 10px">With VO: skips all AI gen (~$0.02)</div>
<div style="font-family:var(--f1);font-size:.5em;color:var(--txtd);letter-spacing:.15em;margin-bottom:4px">CTA CLIP (OPTIONAL)</div>
<div class="man-card" id="m-cta-card">
<div class="man-card-preview" id="m-cta-preview"><div class="man-card-empty" onclick="document.querySelector('#m-cta-card .man-url').focus()"><span style="font-size:1.5em">‚ñ∂</span><span>End card</span></div></div>
<div class="man-card-bar"><input class="fin man-url mc-cta" placeholder="CTA clip URL" style="flex:1;font-size:.85em" onchange="renderCtaCard('m')" onpaste="setTimeout(()=>renderCtaCard('m'),100)"><button class="btn-upload" onclick="uploadFile(this,'video')">‚ñ§</button></div>
</div>
<div style="font-size:.45em;color:var(--txtdd);margin-top:3px">Leave empty for default.</div>
</div>

<div class="mpage" id="mp-topics">
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:.5em">
<button class="btn-sm" onclick="seedTopics()">SEED</button>
<button class="btn-sm btn-blu" onclick="generateTopicsAI()">‚ú¶ AI GEN</button>
</div>
<div class="panel" style="padding:.5em;margin-bottom:.5em">
<input class="fin" id="m-ti" placeholder="New topic idea..." style="margin-bottom:4px">
<div style="display:flex;gap:4px">
<select class="fin" id="m-tc" style="flex:1"><option>Shocking Revelations</option><option>Shocking Reveal</option><option>Behind-the-Scenes</option><option>Myths Debunked</option><option>Deep Dive Analysis</option></select>
<input class="fin" id="m-ts" placeholder="Scripture..." style="width:6em">
<button class="btn-sm btn-grn" onclick="addNewTopic()">+</button>
</div>
</div>
<div class="panel" id="m-tl" style="padding:0;max-height:60vh;overflow-y:auto"></div>
</div>

<div class="mpage" id="mp-runs"><div class="g4m" id="m-rs"></div><div class="panel" id="m-rl"></div></div>
<div class="mpage" id="mp-logs"><div class="logp" id="m-la"></div></div>

<div class="mpage" id="mp-preview">
<div id="m-pve" class="panel" style="padding:20px;text-align:center"><div style="font-size:.65em;color:var(--txtd)">NO ASSETS YET</div></div>
<div id="m-pvi" class="hd"><div style="font-family:var(--f1);font-size:.55em;color:var(--amb);letter-spacing:.15em;margin-bottom:.3em">IMAGES</div><div id="m-pig" class="pgrid"></div></div>
<div id="m-pvv" class="hd"><div style="font-family:var(--f1);font-size:.55em;color:var(--amb);letter-spacing:.15em;margin:.7em 0 .3em">CLIPS</div><div id="m-pvg" class="pgrid"></div></div>
<div id="m-pvf" class="hd"><div class="fvid"><video id="m-fv" controls></video></div><a id="m-fd" href="#" download style="display:block;text-align:center;padding:10px;border:1px solid var(--amb);background:var(--amblo);color:var(--amb);font-family:var(--f1);font-size:.6em;letter-spacing:.15em;text-decoration:none;margin-top:.3em">‚¨á DOWNLOAD</a></div>
<div id="m-pvs" class="hd" style="margin-top:10px"><div id="m-pst" class="panel" style="font-size:.8em;color:var(--wht);line-height:1.8"></div></div>
</div>

<div class="mpage" id="mp-settings"><div id="m-ss" class="sm hd">‚úì SAVED</div><div id="m-sf"></div><button class="sv" onclick="saveSett()">SAVE CONFIGURATION</button></div>

<div class="mpage" id="mp-health">
<div class="panel" id="m-hl" style="margin-bottom:8px"></div>
<button style="width:100%;padding:12px;background:var(--bg);border:1px solid var(--bd2);color:var(--amb);font-size:.75em;min-height:3.2em" onclick="testAll()">TEST ALL CONNECTIONS ‚Üí</button>
<button id="m-thm" onclick="toggleTheme()" style="width:100%;padding:12px;margin-top:8px;background:none;border:1px solid var(--bd2);color:var(--txtd);font-family:var(--f1);font-size:.6em;letter-spacing:.2em;min-height:3.2em">‚òÄ LIGHT MODE</button>
<button onclick="sessionStorage.removeItem('kt');$('L').style.display='flex';$('A').classList.add('hd')" style="width:100%;padding:12px;margin-top:8px;border:1px solid rgba(255,0,60,.12);background:var(--red2);font-family:var(--f1);font-size:.6em;color:var(--red);letter-spacing:.2em;min-height:3.2em">‚ö† DISCONNECT</button>
</div>

<div class="mpage" id="mp-channels">
<div class="panel">
<div style="font-family:var(--f1);font-size:.55em;letter-spacing:.15em;color:var(--txtd);margin-bottom:.5em">BLOTATO CHANNELS</div>
<div class="fi"><div class="fl">INSTAGRAM ID</div><input class="fin" id="mch-instagram" placeholder="e.g. 31177" style="min-height:3em"></div>
<div class="fi"><div class="fl">FACEBOOK ID</div><input class="fin" id="mch-facebook" style="min-height:3em"></div>
<div class="fi"><div class="fl">FACEBOOK PAGE ID</div><input class="fin" id="mch-facebook-page" style="min-height:3em"></div>
<div class="fi"><div class="fl">X / TWITTER ID</div><input class="fin" id="mch-twitter" style="min-height:3em"></div>
<div class="fi"><div class="fl">THREADS ID</div><input class="fin" id="mch-threads" style="min-height:3em"></div>
<div class="fi"><div class="fl">TIKTOK ID</div><input class="fin" id="mch-tiktok" style="min-height:3em"></div>
<div class="fi"><div class="fl">YOUTUBE ID</div><input class="fin" id="mch-youtube" style="min-height:3em"></div>
<div class="fi"><div class="fl">PINTEREST ID</div><input class="fin" id="mch-pinterest" style="min-height:3em"></div>
<div class="fi"><div class="fl">PINTEREST BOARD ID</div><input class="fin" id="mch-pinterest-board" style="min-height:3em"></div>
<button class="sv" onclick="saveChannels()" style="margin-top:.8em">SAVE CHANNELS</button>
<div id="mch-status" style="font-size:.6em;color:var(--txtd);margin-top:.4em"></div>
</div>
</div>
</div>
</div>
<script>
let RN=false,PH=0,PD=[],ST={},LAST_RESULT=null,GATE=null,SCENE_DATA=null;
const $=id=>document.getElementById(id);
const TB=(s)=>{const m={new:'m',processing:'b',executed:'g',published:'g',failed:'r'};const l={new:'NEW',processing:'ACTIVE',executed:'DONE',published:'DONE',failed:'FAIL'};const c=m[(s||'new').toLowerCase()]||'m';return '<span class="bg bg-'+c+'"><span class="bd2"></span>'+(l[(s||'new').toLowerCase()]||s)+'</span>';};
const B=(s,l)=>{const c={done:'g',running:'b',failed:'r',configured:'g',missing:'r',waiting:'m',gated:'o'}[s]||'m';return`<span class="bg bg-${c}"><span class="bd2"></span>${l||s}</span>`};
const PHS=[{n:"FETCH TOPIC",a:"LOCAL DB",i:"‚¨°",d:"~1s"},{n:"GENERATE SCRIPT",a:"GPT-4o",i:"‚¨¢",d:"~3s"},{n:"SCENE ENGINE",a:"LOCAL",i:"‚óà",d:"<1s"},{n:"GENERATE IMAGES",a:"REPLICATE",i:"‚óâ",d:"~30s"},{n:"GENERATE VIDEOS",a:"REPLICATE",i:"‚ñ∂",d:"~120s"},{n:"VOICEOVER",a:"ELEVENLABS",i:"‚óé",d:"~4s"},{n:"TRANSCRIBE",a:"WHISPER",i:"‚ñ§",d:"~3s"},{n:"UPLOAD ASSETS",a:"R2",i:"‚¨Ü",d:"~8s"},{n:"FINAL RENDER",a:"SHOTSTACK",i:"‚¨°",d:"~90s"},{n:"CAPTIONS",a:"GPT-4o",i:"‚úé",d:"~4s"},{n:"PUBLISH",a:"BLOTATO",i:"‚óá",d:"~6s"}];

const STS=[
{t:"BRAND",f:[{k:"brand_name",l:"Brand Name",d:"Knights Reactor",b:1},{k:"brand_tagline",l:"Tagline",d:"Biblical content for men of faith",b:1},{k:"brand_persona",l:"Character Persona",tp:"textarea",d:"A battle-hardened Christian knight: Strong, disciplined, capable, calm. Not cruel, not cold‚Äîfirm and compassionate. Protector of faith, family, duty, truth. Lives in peace but ready for war. Wears the Armor of God (Ephesians 6) symbolically. Unwavering allegiance: Christ is King.",b:1},{k:"brand_voice",l:"Voice Description",tp:"textarea",d:"Low, controlled, resonant. Calm intensity; authoritative without shouting. Short, declarative sentences. Measured pacing. Dark, mysterious presence‚Äîdisciplined resolve. Masculine and grounded. NO hype. NO motivational fluff.",b:1},{k:"brand_themes",l:"Core Themes",tp:"textarea",d:"Address real daily battles: Finances, family leadership, temptation, fatigue, doubt, lust, anger, responsibility, endurance, obedience. Discipline over comfort. Duty over desire. Endurance over escape. Faith over fear. Action over emotion.",b:1},{k:"brand_avoid",l:"What to Avoid",d:"Warmth or sentimentality, soft encouragement, modern slang, politics, long scripture quotations, hashtags",b:1}]},
{t:"SCRIPT ENGINE",f:[{k:"script_model",l:"AI Model",tp:"select",o:["gpt-4o","gpt-4o-mini"],d:"gpt-4o"},{k:"script_temp",l:"Temperature",d:"0.85"},{k:"script_words",l:"Script Length",tp:"slider",min:30,max:180,step:5,d:90}]},
{t:"SCENE ENGINE",f:[{k:"scene_story",l:"Story Seed",tp:"select",o:["auto"],d:"auto",dynamic:"stories"},{k:"scene_theme",l:"Theme Force",tp:"select",o:["auto"],d:"auto",dynamic:"themes"},{k:"scene_figure",l:"Figure",tp:"select",o:["auto"],d:"auto",dynamic:"figures"},{k:"scene_intensity",l:"Intensity",tp:"select",o:["still","measured","dynamic"],d:"measured"},{k:"scene_camera",l:"Camera Style",tp:"select",o:["steady","dynamic","handheld"],d:"steady"},{k:"scene_mood",l:"Mood Lighting",tp:"select",o:["auto"],d:"auto",dynamic:"moods"},{k:"_scene_pack",l:"",tp:"scene_pack"}]},
{t:"VOICE SYNTH",f:[{k:"voice_id",l:"Voice ID",d:"bwCXcoVxWNYMlC6Esa8u",b:1},{k:"voice_model",l:"Model",tp:"select",o:["eleven_turbo_v2","eleven_multilingual_v2","eleven_monolingual_v1"],d:"eleven_turbo_v2"},{k:"voice_stability",l:"Stability",d:"0.5"},{k:"voice_similarity",l:"Similarity",d:"0.75"},{k:"voice_speed",l:"Speed",d:"1.0"},{k:"voice_style",l:"Style",d:"0.0"}]},
{t:"IMAGE GENERATION",f:[{k:"image_provider",l:"Provider",tp:"select",o:["replicate"],d:"replicate"},{k:"image_model",l:"Model",tp:"select",o:[],d:"black-forest-labs/flux-1.1-pro",dep:"image_provider"},{k:"image_quality",l:"Quality",tp:"select",o:["low","medium","high"],d:"high"}]},
{t:"VIDEO GENERATION",f:[{k:"video_provider",l:"Provider",tp:"select",o:["replicate"],d:"replicate"},{k:"video_model",l:"Model",tp:"select",o:[],d:"bytedance/seedance-1-lite",dep:"video_provider"},{k:"clip_count",l:"Clips",tp:"select",o:["2","3","4","5"],d:"3"},{k:"clip_duration",l:"Clip Duration",tp:"select",o:["5","8","10","12","15"],d:"10"},{k:"cta_enabled",l:"CTA End Card",tp:"toggle",d:true},{k:"cta_duration",l:"CTA Duration (sec)",tp:"select",o:["3","4","5","6","8"],d:"5"},{k:"_vid_total",l:"",tp:"computed"},{k:"video_timeout",l:"Timeout (sec)",d:"600"}]},
{t:"RENDER OUTPUT",f:[{k:"shotstack_env",l:"Shotstack Mode",tp:"select",o:["stage","v1"],d:"stage"},{k:"render_fps",l:"FPS",tp:"select",o:["24","30","60"],d:"30"},{k:"render_res",l:"Resolution",tp:"select",o:["720","1080"],d:"1080"},{k:"render_aspect",l:"Aspect Ratio",tp:"select",o:["9:16","16:9","1:1"],d:"9:16"},{k:"render_bg",l:"Background Color",d:"#000000"}]},
{t:"WATERMARK / LOGO",f:[{k:"logo_enabled",l:"Show Logo",tp:"toggle",d:true},{k:"captions_enabled",l:"Show Captions",tp:"toggle",d:true},{k:"logo_url",l:"Logo URL",d:""},{k:"logo_position",l:"Position",tp:"select",o:["topRight","topLeft","bottomRight","bottomLeft","center"],d:"topRight"},{k:"logo_scale",l:"Scale",d:"0.12"},{k:"logo_opacity",l:"Opacity",d:"0.8"}]},
{t:"PLATFORMS",f:[{k:"on_tt",l:"TikTok",tp:"toggle",d:true},{k:"on_yt",l:"YouTube",tp:"toggle",d:true},{k:"on_ig",l:"Instagram",tp:"toggle",d:true},{k:"on_fb",l:"Facebook",tp:"toggle",d:true},{k:"on_tw",l:"X/Twitter",tp:"toggle",d:true},{k:"on_th",l:"Threads",tp:"toggle",d:true},{k:"on_pn",l:"Pinterest",tp:"toggle",d:false}]}
];
let stOpen={};
const IMG_MODELS={replicate:[{v:"google/nano-banana-pro",l:"Nano Banana Pro"},{v:"google/nano-banana",l:"Nano Banana"},{v:"xai/grok-imagine-image",l:"Grok Aurora"},{v:"bytedance/seedream-4.5",l:"Seedream 4.5"},{v:"black-forest-labs/flux-1.1-pro",l:"Flux 1.1 Pro"},{v:"black-forest-labs/flux-schnell",l:"Flux Schnell"},{v:"black-forest-labs/flux-dev",l:"Flux Dev"},{v:"ideogram-ai/ideogram-v3-quality",l:"Ideogram v3 Q"},{v:"ideogram-ai/ideogram-v3-turbo",l:"Ideogram v3 T"},{v:"recraft-ai/recraft-v3",l:"Recraft v3"},{v:"stability-ai/stable-diffusion-3.5-large",l:"SD 3.5 L"},{v:"google-deepmind/imagen-4-preview",l:"Imagen 4"}]};
const VID_MODELS={replicate:[{v:"bytedance/seedance-1-lite",l:"Seedance Lite"},{v:"bytedance/seedance-1",l:"Seedance Pro"},{v:"wavespeedai/wan-2.1-i2v-480p",l:"Wan 480p"},{v:"wavespeedai/wan-2.1-i2v-720p",l:"Wan 720p"},{v:"xai/grok-imagine-video",l:"Grok Video"},{v:"minimax/video-01-live",l:"Minimax Live"},{v:"minimax/video-01",l:"Minimax v01"},{v:"kwaivgi/kling-v2.0-image-to-video",l:"Kling v2.0"},{v:"luma/ray-2-flash",l:"Luma Flash"},{v:"luma/ray-2",l:"Luma Ray 2"},{v:"google-deepmind/veo-3",l:"Veo 3"}]};
const SVCS=[{n:"OPENAI",d:"GPT-4o + Whisper",k:"openai"},{n:"REPLICATE",d:"Image + Video",k:"replicate"},{n:"ELEVENLABS",d:"Voice Synthesis",k:"elevenlabs"},{n:"SHOTSTACK",d:"Video Render",k:"shotstack"},{n:"R2",d:"Asset Storage",k:"r2"},{n:"BLOTATO",d:"Publishing",k:"blotato"}];
const titles={pipeline:'‚ö° PIPELINE MONITOR',manual:'‚óà MANUAL PIPELINE',topics:'‚ú¶ TOPIC DATABASE',runs:'‚óà RUN HISTORY',logs:'‚ñ§ SYSTEM LOGS',preview:'‚óâ ASSET PREVIEW',settings:'‚öô CONFIGURATION',health:'‚óé SYSTEM STATUS',channels:'üì° PUBLISHING CHANNELS'};

/* THEME */
function toggleTheme(){const on=document.documentElement.classList.toggle('light');localStorage.setItem('kr-theme',on?'light':'dark');updThemeBtn();}
function updThemeBtn(){const lt=document.documentElement.classList.contains('light');['d-thm','m-thm'].forEach(id=>{const el=$(id);if(el)el.textContent=lt?'‚óë DARK MODE':'‚òÄ LIGHT MODE';});}
(function(){if(localStorage.getItem('kr-theme')==='light')document.documentElement.classList.add('light');})();

/* AUTH */
async function go(){const p=$('pw').value;if(!p){$('le').style.display='block';return;}try{const r=await(await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:p})})).json();if(r.ok){if(r.token)sessionStorage.setItem('kt',r.token);$('L').style.display='none';$('A').classList.remove('hd');init();}else{$('le').style.display='block';}}catch(e){$('le').style.display='block';}}
async function autoLogin(){const t=sessionStorage.getItem('kt');if(!t)return;try{const r=await(await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:t})})).json();if(r.ok){$('L').style.display='none';$('A').classList.remove('hd');init();}}catch(e){}}

/* NAV */
function dNav(p,btn){document.querySelectorAll('.dpage').forEach(e=>e.classList.remove('on'));document.querySelectorAll('.sb-i').forEach(b=>b.classList.remove('on'));$('dp-'+p).classList.add('on');if(btn)btn.classList.add('on');$('d-title').textContent=titles[p]||p;if(p==='topics')loadTopics();if(p==='runs')loadRuns();if(p==='logs')loadLogs();if(p==='preview')rPv();if(p==='health')rH();if(p==='channels')loadChannels();}
function mNav(p,btn){document.querySelectorAll('.mpage').forEach(e=>e.classList.remove('on'));document.querySelectorAll('.mt').forEach(b=>b.classList.remove('on'));$('mp-'+p).classList.add('on');if(btn)btn.classList.add('on');if(p==='topics')loadTopics();if(p==='runs')loadRuns();if(p==='logs')loadLogs();if(p==='preview')rPv();if(p==='health')rH();if(p==='channels')loadChannels();}

/* ‚ïê‚ïê‚ïê GATE BANNERS ‚ïê‚ïê‚ïê */
function rGate(){
  let h='';
  if(GATE==='prompts'){
    h=`<div class="gate-banner"><div class="g-icon">‚úé</div><div class="g-text"><div class="g-title">PROMPT EDITING GATE</div><div class="g-sub">Scene Engine complete ‚Äî review and edit image/motion prompts before generating</div></div><div style="display:flex;gap:6px"><button class="btn-sm btn-blu" onclick="openPromptEditor()">EDIT PROMPTS</button><button class="btn-sm btn-grn" onclick="resumeNow()">APPROVE & CONTINUE ‚ñ∂</button></div></div>`;
  }else if(GATE==='videos'){
    h=`<div class="gate-banner"><div class="g-icon">‚ñ∂</div><div class="g-text"><div class="g-title">VIDEO APPROVAL GATE</div><div class="g-sub">Videos generated ‚Äî review clips, regenerate if needed, then approve</div></div><div style="display:flex;gap:6px"><button class="btn-sm btn-blu" onclick="openVideoReview()">REVIEW CLIPS</button><button class="btn-sm btn-grn" onclick="approveAllVideos()">APPROVE ALL ‚ñ∂</button></div></div>`;
  }
  ['d-gate','m-gate'].forEach(id=>{if($(id))$(id).innerHTML=h;});
  if(GATE==='prompts')setTimeout(openPromptEditor,100);
  if(GATE==='videos')setTimeout(openVideoReview,100);
}

/* ‚ïê‚ïê‚ïê PROMPT EDITOR ‚ïê‚ïê‚ïê */
async function openPromptEditor(){
  try{
    const r=await(await fetch('/api/prompts')).json();
    if(!r.clips||!r.clips.length){alert('No prompts found');return;}
    let h='<div style="font-family:var(--f1);font-size:.7em;letter-spacing:.15em;color:var(--amb);margin-bottom:.5em">EDIT SCENE PROMPTS</div>';
    if(r.script)h+=`<div class="panel" style="font-size:.75em;color:var(--wht);line-height:1.6;margin-bottom:.7em"><b style="color:var(--amb)">Script:</b> ${r.script.script_full||''}</div>`;
    r.clips.forEach(c=>{
      h+=`<div class="clip-edit" id="ce-${c.index}"><div class="ce-head">SCENE ${c.index}</div><div class="fl">IMAGE PROMPT</div><textarea id="ip-${c.index}" rows="3">${c.image_prompt||''}</textarea><div class="fl" style="margin-top:.4em">MOTION PROMPT</div><textarea id="mp-${c.index}" rows="2">${c.motion_prompt||''}</textarea></div>`;
    });
    h+=`<div style="display:flex;gap:8px;margin-top:.7em"><button class="btn-sm btn-grn" onclick="savePrompts(${r.clips.length})">SAVE & CONTINUE ‚ñ∂</button><button class="btn-sm" onclick="rP()">CANCEL</button></div>`;
    // Show in pipeline area
    ['d-pl','m-pl'].forEach(id=>{if($(id))$(id).innerHTML=h;});
    ['d-stats'].forEach(id=>{if($(id))$(id).innerHTML='';});
  }catch(e){alert('Error loading prompts: '+e);}
}

async function savePrompts(count){
  const clips=[];
  for(let i=1;i<=count;i++){
    const ip=$('ip-'+i),mp=$('mp-'+i);
    if(ip&&mp)clips.push({index:i,image_prompt:ip.value,motion_prompt:mp.value});
  }
  try{
    await fetch('/api/prompts/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({clips})});
    GATE=null;rGate();
    resumeNow();
  }catch(e){alert('Save failed: '+e);}
}

/* ‚ïê‚ïê‚ïê VIDEO REVIEW ‚ïê‚ïê‚ïê */
async function openVideoReview(){
  try{
    const r=await(await fetch('/api/videos/review')).json();
    if(!r.clips||!r.clips.length){alert('No videos found');return;}
    let h='<div style="font-family:var(--f1);font-size:.7em;letter-spacing:.15em;color:var(--amb);margin-bottom:.5em">REVIEW VIDEO CLIPS</div>';
    r.clips.forEach(c=>{
      h+=`<div class="clip-review" id="vr-${c.index}"><video src="${c.video_url}" controls muted playsinline></video><div style="font-size:.65em;color:var(--txtd);margin-bottom:.3em">Clip ${c.index}</div><div class="cr-acts"><button class="btn-sm btn-red" onclick="regenClip(${c.index})">‚ôª REGENERATE</button><span id="vrs-${c.index}" style="font-size:.6em;color:var(--txtd)"></span></div></div>`;
    });
    h+=`<div style="display:flex;gap:8px;margin-top:.7em"><button class="btn-sm btn-grn" onclick="approveAllVideos()">APPROVE ALL & CONTINUE ‚ñ∂</button><button class="btn-sm" onclick="rP()">CANCEL</button></div>`;
    ['d-pl','m-pl'].forEach(id=>{if($(id))$(id).innerHTML=h;});
    ['d-stats'].forEach(id=>{if($(id))$(id).innerHTML='';});
  }catch(e){alert('Error loading videos: '+e);}
}

async function regenClip(idx){
  const st=$('vrs-'+idx);
  if(st)st.textContent='Regenerating...';
  try{
    const r=await(await fetch('/api/videos/regen',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({index:idx})})).json();
    if(r.clip){
      const vr=$('vr-'+idx);
      if(vr){const vid=vr.querySelector('video');if(vid)vid.src=r.clip.video_url;}
      if(st)st.textContent='Regenerated ‚úì';
    }else{if(st)st.textContent='Failed: '+(r.error||'unknown');}
  }catch(e){if(st)st.textContent='Error: '+e;}
}

async function approveAllVideos(){
  try{
    const r=await(await fetch('/api/videos/review')).json();
    await fetch('/api/videos/approve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({clips:r.clips||[]})});
    GATE=null;rGate();
    resumeNow();
  }catch(e){alert('Approval failed: '+e);}
}

/* ‚ïê‚ïê‚ïê PIPELINE RENDER ‚ïê‚ïê‚ïê */
function rP(){
  let h='';
  PHS.forEach((p,i)=>{
    let s='waiting',c='',sl='';
    if(PD.includes(i)){s='done';c='dn';sl='COMPLETE';}
    else if(RN&&i===PH){s='running';c='rn';sl='ACTIVE';}
    else if(RN&&i<PH){s='done';c='dn';sl='COMPLETE';}
    else if(RN){c='dm';}
    // Gate markers
    if(!RN&&GATE==='prompts'&&i===2){s='gated';c='gt';sl='GATE';}
    if(!RN&&GATE==='videos'&&i===4){s='gated';c='gt';sl='GATE';}
    const nc=s==='done'?'var(--grn)':s==='running'?'var(--blu)':s==='gated'?'var(--amb)':'var(--txtdd)';
    const nt=s==='done'?'var(--grn)':s==='running'?'var(--amb)':s==='gated'?'var(--amb)':'var(--txtd)';
    h+=`<div class="ph ${c}"><div style="display:flex;align-items:center;gap:.55em"><span style="font-size:.8em;width:1.15em;text-align:center;color:${nc}">${p.i}</span><div style="flex:1"><div style="font-family:var(--f1);font-size:.6em;font-weight:600;letter-spacing:.15em;color:${nt}">${p.n}</div><div style="font-size:.5em;color:var(--txtdd);margin-top:.05em;letter-spacing:.08em">${p.a} ¬∑ ${p.d}</div></div>${sl?`<span style="font-family:var(--f1);font-size:.5em;color:${nc};letter-spacing:1px">${sl}</span>`:''} ${B(s)}</div></div>`;
  });
  ['d-pl','m-pl'].forEach(id=>{if($(id))$(id).innerHTML=h;});
  const pct=(PD.length/PHS.length*100);
  ['d-pb','m-pb'].forEach(id=>{if($(id))$(id).style.width=pct+'%';});
  rGate();
  // Stats
  if($('d-stats')){const t=PD.length,tot=PHS.length;$('d-stats').innerHTML=[{l:'PHASES',v:t+'/'+tot,c:'amb'},{l:'PROGRESS',v:Math.round(pct)+'%',c:pct>=100?'grn':'blu'},{l:'STATUS',v:RN?'RUNNING':GATE?'GATED':'IDLE',c:RN?'blu':GATE?'amb':'txtd'},{l:'LAST',v:LAST_RESULT?LAST_RESULT.status:'‚Äî',c:LAST_RESULT&&LAST_RESULT.status==='failed'?'red':'grn'}].map(s=>`<div class="stat"><b style="color:var(--${s.c})">${s.v}</b><small style="color:var(--${s.c})">${s.l}</small></div>`).join('');}
  // Phase indicator
  if(RN){
    if($('d-ph'))$('d-ph').textContent='PHASE '+(PH+1)+'/11';
    ['d-rb','m-rb','d-rb2','m-rb2'].forEach(id=>{if($(id)){$(id).textContent='‚è≥';$(id).style.background='var(--bg3)';$(id).style.color='var(--txtd)';}});
  }else{
    if($('d-ph'))$('d-ph').textContent='';
    if($('d-rb')){$('d-rb').textContent='‚ñ∂ EXECUTE';$('d-rb').style.background='var(--amb)';$('d-rb').style.color='var(--bg)';}
    if($('m-rb')){$('m-rb').textContent='‚ñ∂ EXECUTE';$('m-rb').style.background='var(--amb)';$('m-rb').style.color='var(--bg)';}
    if($('d-rb2')){$('d-rb2').textContent='‚ñ∂ EXECUTE';$('d-rb2').style.background='var(--amb)';$('d-rb2').style.color='var(--bg)';}
    if($('m-rb2')){$('m-rb2').textContent='‚ñ∂ EXECUTE';$('m-rb2').style.background='var(--amb)';$('m-rb2').style.color='var(--bg)';}
  }
  // Resume button ‚Äî show for gates and failures
  const showRes=(!RN&&(GATE||LAST_RESULT&&LAST_RESULT.status==='failed'));
  ['d-rsb','m-rsb','d-rsb2'].forEach(id=>{if($(id))$(id).style.display=showRes?'block':'none';});
}

/* ‚ïê‚ïê‚ïê ACTIONS ‚ïê‚ïê‚ïê */
async function runNow(topicId){
  if(RN)return;
  const body=topicId?{topic_id:topicId}:{};
  await fetch('/api/run',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  RN=true;PH=0;PD=[];GATE=null;rP();poll();
}
async function resumeNow(){
  if(RN)return;
  const r=await fetch('/api/resume',{method:'POST'});
  const d=await r.json();
  if(r.ok){RN=true;GATE=null;PD=[];rP();poll();}
  else{alert(d.error||'Resume failed');}
}
/* Manual clip card system */
let manClips=[{url:''},{url:''},{url:''}]; // Start with 3 empty slots

function renderManualCards(px){
  const grid=$(px+'-mclips');
  if(!grid)return;
  grid.innerHTML='';
  manClips.forEach((clip,i)=>{
    const card=document.createElement('div');
    card.className='man-card';
    card.dataset.idx=i;
    const url=clip.url||'';
    const hasUrl=url&&url.startsWith('http');
    let previewHtml='';
    if(hasUrl){
      previewHtml=`<video src="${url}" muted loop playsinline onmouseenter="this.play()" onmouseleave="this.pause();this.currentTime=0" ontouchstart="this.paused?this.play():this.pause()"></video>`;
      if(clip.dur) previewHtml+=`<div class="man-card-badge">${fmtDur(clip.dur)}</div>`;
      previewHtml+=`<div class="man-card-num">CLIP ${i+1}</div>`;
      if(manClips.length>1) previewHtml+=`<div class="man-card-rm" onclick="removeClip(${i})">‚úï</div>`;
    }else{
      previewHtml=`<div class="man-card-empty" onclick="this.closest('.man-card').querySelector('.man-url').focus()"><span style="font-size:1.5em">‚ñ∂</span><span>CLIP ${i+1}</span></div>`;
      if(manClips.length>1) previewHtml+=`<div class="man-card-rm" style="opacity:1" onclick="event.stopPropagation();removeClip(${i})">‚úï</div>`;
    }
    card.innerHTML=`<div class="man-card-preview">${previewHtml}</div><div class="man-card-bar"><input class="fin man-url mc-url" value="${url}" placeholder="Clip ${i+1} URL" style="flex:1" data-idx="${i}" onchange="onClipUrl(this)" onpaste="setTimeout(()=>onClipUrl(this),100)"><button class="btn-upload" onclick="uploadFile(this,'video')">‚ñ§</button></div>`;
    grid.appendChild(card);
  });
}
function fmtDur(s){return s>=60?Math.floor(s/60)+'m'+Math.round(s%60)+'s':Math.round(s*10)/10+'s';}
async function onClipUrl(inp){
  const idx=parseInt(inp.dataset.idx);
  const url=inp.value.trim();
  manClips[idx].url=url;
  manClips[idx].dur=0;
  // Re-render both grids
  ['d','m'].forEach(px=>renderManualCards(px));
  // Probe duration
  if(url&&url.startsWith('http')){
    try{
      const r=await fetch('/api/probe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url})});
      const d=await r.json();
      if(d.duration){manClips[idx].dur=d.duration;}
    }catch(e){}
    ['d','m'].forEach(px=>renderManualCards(px));
  }
  updateTotals();
}
function removeClip(idx){
  if(manClips.length<=1)return;
  manClips.splice(idx,1);
  ['d','m'].forEach(px=>renderManualCards(px));
  updateTotals();
}
function addClipCard(px){
  if(manClips.length>=6)return;
  manClips.push({url:''});
  ['d','m'].forEach(p=>renderManualCards(p));
}
function renderVoCard(px){
  const inp=document.querySelector('#'+px+'-vo-card .man-url');
  const prev=$(px+'-vo-preview');
  if(!inp||!prev)return;
  const url=inp.value.trim();
  if(url&&url.startsWith('http')){
    prev.innerHTML=`<audio src="${url}" controls style="width:100%;margin-top:.5em"></audio>`;
  }else{
    prev.innerHTML=`<div class="man-card-empty" onclick="document.querySelector('#${px}-vo-card .man-url').focus()"><span style="font-size:1.5em">‚óé</span><span>Paste URL or upload audio</span></div>`;
  }
}
function renderCtaCard(px){
  const inp=document.querySelector('#'+px+'-cta-card .man-url');
  const prev=$(px+'-cta-preview');
  if(!inp||!prev)return;
  const url=inp.value.trim();
  if(url&&url.startsWith('http')){
    prev.innerHTML=`<video src="${url}" muted loop playsinline onmouseenter="this.play()" onmouseleave="this.pause();this.currentTime=0" ontouchstart="this.paused?this.play():this.pause()" style="width:100%;height:100%;object-fit:cover"></video>`;
  }else{
    prev.innerHTML=`<div class="man-card-empty" onclick="document.querySelector('#${px}-cta-card .man-url').focus()"><span style="font-size:1.5em">‚ñ∂</span><span>End card</span></div>`;
  }
}
// Keep old name for uploadFile compat
function addClipSlot(prefix){addClipCard(prefix);}
async function probeUrl(inp){onClipUrl(inp);}
async function probeVo(inp){
  const url=inp.value.trim();
  const durSpan=inp.parentElement.querySelector('.vo-dur');
  if(!durSpan)return;
  if(!url||!url.startsWith('http')){durSpan.textContent='';updateTotals();return;}
  durSpan.textContent='‚è≥';durSpan.style.color='var(--blu)';
  try{
    const r=await fetch('/api/probe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url})});
    const d=await r.json();
    if(d.duration){
      const s=d.duration;
      durSpan.textContent=s>=60?Math.floor(s/60)+'m'+Math.round(s%60)+'s':Math.round(s*10)/10+'s';
      durSpan.style.color='var(--grn)';durSpan.dataset.dur=s;
    }else{durSpan.textContent='?';durSpan.style.color='var(--red)';durSpan.dataset.dur='';}
  }catch(e){durSpan.textContent='‚úó';durSpan.style.color='var(--red)';durSpan.dataset.dur='';}
  updateTotals();
}
function updateTotals(){
  let clipTotal=0,clipCount=0;
  manClips.forEach(c=>{if(c.dur>0){clipTotal+=c.dur;clipCount++;}});
  let voTotal=0;
  document.querySelectorAll('.vo-dur').forEach(el=>{
    const d=parseFloat(el.dataset.dur);if(d>0&&voTotal===0)voTotal=d;
  });
  ['d','m'].forEach(px=>{
    const bar=$(px+'-mtotals');
    if(!bar)return;
    if(clipCount===0&&voTotal===0){bar.style.display='none';return;}
    bar.style.display='flex';
    const fmt=s=>s>=60?Math.floor(s/60)+'m'+Math.round(s%60)+'s':Math.round(s*10)/10+'s';
    $(px+'-mt-clips').textContent='CLIPS: '+fmt(clipTotal);
    $(px+'-mt-vo').textContent=voTotal>0?'VOICE: '+fmt(voTotal):'';
    const final=voTotal>0?voTotal:clipTotal;
    $(px+'-mt-total').textContent='VIDEO: '+fmt(final);
  });
}
async function uploadFile(btn, type){
  const accept = type==='audio' ? 'audio/*,.mp3,.wav,.m4a,.flac,.ogg' : 'video/*,.mp4,.mov,.webm,.avi';
  const input = document.createElement('input');
  input.type='file';
  input.accept=accept;
  input.onchange=async function(){
    const file=input.files[0];
    if(!file)return;
    const row=btn.parentElement;
    const textInput=row.querySelector('.man-url,.mc-url,.mc-vo,.mc-cta');
    if(!textInput)return;
    const origText=btn.textContent;
    btn.textContent='‚è≥';
    btn.classList.add('uploading');
    try{
      const form=new FormData();
      form.append('file',file);
      const r=await fetch('/api/upload',{method:'POST',body:form});
      const d=await r.json();
      if(d.url){
        textInput.value=d.url;
        btn.textContent='‚úì';
        setTimeout(()=>btn.textContent=origText,2000);
        // Trigger the appropriate handler
        if(textInput.classList.contains('mc-url')){
          onClipUrl(textInput);
        }else if(textInput.classList.contains('mc-vo')){
          probeVo(textInput);
          ['d','m'].forEach(px=>renderVoCard(px));
        }else if(textInput.classList.contains('mc-cta')){
          ['d','m'].forEach(px=>renderCtaCard(px));
        }
      }else{
        textInput.value='';
        btn.textContent='‚úó';
        alert(d.error||'Upload failed');
        setTimeout(()=>btn.textContent=origText,2000);
      }
    }catch(e){
      textInput.value='';
      btn.textContent='‚úó';
      alert('Upload error: '+e.message);
      setTimeout(()=>btn.textContent=origText,2000);
    }
    btn.classList.remove('uploading');
  };
  input.click();
}
async function manualRun(){
  if(RN)return;
  // Gather clip URLs from manClips array
  const urls=manClips.filter(c=>c.url&&c.url.startsWith('http')).map(c=>c.url);
  if(!urls.length){alert('Paste at least 1 video URL');return;}
  // Gather voiceover URL (check both d and m inputs)
  let vo='';
  document.querySelectorAll('.mc-vo').forEach(inp=>{
    const v=inp.value.trim();
    if(v&&v.startsWith('http'))vo=v;
  });
  // Gather CTA clip URL
  let cta='';
  document.querySelectorAll('.mc-cta').forEach(inp=>{
    const v=inp.value.trim();
    if(v&&v.startsWith('http'))cta=v;
  });
  const body={clips:urls};
  if(vo)body.voiceover=vo;
  if(cta)body.cta_url=cta;
  const mode=vo?'FULL MANUAL (clips + voiceover)':'MANUAL (clips only)';
  if(!confirm(`Start ${mode} run?\n\n${urls.length} clip(s)${vo?'\n+ voiceover':''}${cta?'\n+ custom CTA':''}${vo?'\n\nSkips ALL AI generation (~$0.02)':''}`))return;
  const r=await fetch('/api/manual-run',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const d=await r.json();
  if(r.ok){RN=true;PH=0;PD=[];GATE=null;rP();poll();}
  else{alert(d.error||'Manual run failed');}
}
async function scriptOnly(){
  const btn=event.target;btn.textContent='‚è≥ GENERATING...';btn.disabled=true;
  try{
    const r=await fetch('/api/script-only',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({})});
    const d=await r.json();
    if(r.ok&&d.script){
      ['d-','m-'].forEach(px=>{
        const el=$(px+'script-result');if(el)el.classList.remove('hd');
        const t=$(px+'scr-title');if(t)t.textContent=d.topic.idea||'Script';
        const txt=$(px+'scr-text');if(txt)txt.textContent=d.script.script_full||'';
        const meta=$(px+'scr-meta');if(meta)meta.textContent=`${d.topic.category||''} ¬∑ ${(d.script.script_full||'').split(' ').length} words ¬∑ Tone: ${d.script.tone||'?'}`;
        // Render prompts
        const pr=$(px+'scr-prompts');
        if(pr&&d.clips&&d.clips.length){
          let ph='<div style="font-family:var(--f1);font-size:.55em;color:var(--amb);letter-spacing:.15em;margin-bottom:.4em">SCENE PROMPTS</div>';
          d.clips.forEach(c=>{
            ph+=`<div style="background:var(--bg);border:1px solid var(--bd2);padding:.6em;margin-bottom:5px">
              <div style="font-family:var(--f1);font-size:.5em;color:var(--blu);letter-spacing:.12em;margin-bottom:.3em">CLIP ${c.index}</div>
              <div style="font-size:.6em;color:var(--txtd);margin-bottom:.2em">‚óâÔ∏è IMAGE</div>
              <div style="font-size:.7em;color:var(--wht);line-height:1.5;margin-bottom:.4em;cursor:pointer;user-select:all" title="Click to select">${c.image_prompt}</div>
              <div style="font-size:.6em;color:var(--txtd);margin-bottom:.2em">‚ñ∂ MOTION</div>
              <div style="font-size:.7em;color:var(--wht);line-height:1.5;cursor:pointer;user-select:all" title="Click to select">${c.motion_prompt}</div>
            </div>`;
          });
          pr.innerHTML=ph;
        }
      });
    }else{alert(d.error||'Script generation failed');}
  }catch(e){alert('Error: '+e);}
  btn.textContent='‚úé SCRIPT ONLY';btn.disabled=false;
}
async function poll(){
  if(!RN)return;
  try{
    const r=await(await fetch('/api/status')).json();
    PH=r.phase;PD=r.phases_done||[];
    if(r.result){
      LAST_RESULT=r.result;
      GATE=r.result.gate||null;
    }
    if(!r.running){RN=false;rP();rPv();return;}
    RN=true;rP();setTimeout(poll,2000);
  }catch(e){setTimeout(poll,3000);}
}

/* ‚ïê‚ïê‚ïê TOPICS ‚ïê‚ïê‚ïê */
async function loadTopics(){
  try{
    const _tr=await(await fetch('/api/topics')).json();const topics=_tr.topics||_tr;
    const h=topics.length?topics.map(t=>`<div class="topic-row"><div style="flex:1"><div style="font-family:var(--f2);font-size:.85em;font-weight:600;color:var(--wht)">${t.idea}</div><div style="font-size:.55em;color:var(--txtd);margin-top:.05em">${t.category}${t.scripture?' ¬∑ '+t.scripture:''}</div></div><div style="flex-shrink:0;margin-right:.5em">${TB(t.status||'new')}</div><div style="display:flex;gap:4px"><button class="btn-sm btn-grn" onclick="runNow('${t.id}')" title="Run pipeline with this topic">‚ñ∂</button><button class="btn-sm btn-red" onclick="deleteTopic('${t.id}')" title="Delete">‚úï</button></div></div>`).join(''):'<div class="topic-row" style="color:var(--txtd)">No topics ‚Äî seed defaults or add manually</div>';
    ['d-tl','m-tl'].forEach(id=>{if($(id))$(id).innerHTML=h;});
  }catch(e){console.error('loadTopics:',e);}
}

async function addNewTopic(){
  const idea=($('d-ti')||$('m-ti')).value.trim();
  const cat=($('d-tc')||$('m-tc')).value;
  const scr=($('d-ts')||$('m-ts')).value.trim();
  if(!idea){alert('Enter a topic idea');return;}
  await fetch('/api/topics',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({idea,category:cat,scripture:scr})});
  ['d-ti','m-ti','d-ts','m-ts'].forEach(id=>{if($(id))$(id).value='';});
  loadTopics();
}

async function deleteTopic(id){
  if(!confirm('Delete this topic?'))return;
  await fetch('/api/topics/'+id,{method:'DELETE'});
  loadTopics();
}

async function seedTopics(){
  if(!confirm('Seed 100 default topics?'))return;
  await fetch('/api/topics/seed',{method:'POST'});
  loadTopics();
}

async function generateTopicsAI(){
  const btn=event.target;btn.textContent='Generating...';btn.disabled=true;
  try{
    const r=await(await fetch('/api/topics/generate',{method:'POST'})).json();
    alert('Generated '+(r.count||0)+' topics');
    loadTopics();
  }catch(e){alert('Failed: '+e);}
  btn.textContent='‚ú¶ AI GENERATE';btn.disabled=false;
}

/* ‚ïê‚ïê‚ïê RUNS ‚ïê‚ïê‚ïê */
async function loadRuns(){
  try{
    const runs=await(await fetch('/api/runs')).json();
    const t=runs.length,ok=runs.filter(r=>r.status==='published'||r.status==='complete').length;
    const sh=[{l:'TOTAL',v:t,c:'amb'},{l:'SUCCESS',v:ok,c:'grn'},{l:'RATE',v:t?Math.round(ok/t*100)+'%':'‚Äî',c:'blu'},{l:'FAILED',v:t-ok,c:'red'}].map(s=>`<div class="stat"><b style="color:var(--${s.c})">${s.v}</b><small style="color:var(--${s.c})">${s.l}</small></div>`).join('');
    ['d-rs','m-rs'].forEach(id=>{if($(id))$(id).innerHTML=sh;});
    const rh=runs.length?runs.map(r=>`<div class="rw"><div style="display:flex;align-items:center;gap:.55em"><div style="flex:1"><div style="font-family:var(--f2);font-size:.85em;font-weight:600;color:var(--wht)">${r.topic||'?'}</div><div style="font-size:.55em;color:var(--txtd);margin-top:.05em;letter-spacing:.08em">${r.date} ¬∑ ${r.category||''}</div></div>${B(r.status==='published'||r.status==='complete'?'done':'failed',r.status)}</div>${r.error?`<div style="font-size:.65em;color:var(--red);margin-top:.3em;background:var(--red2);padding:.2em .4em">${r.error}</div>`:''}</div>`).join(''):'<div class="rw" style="color:var(--txtd)">NO RUNS</div>';
    ['d-rl','m-rl'].forEach(id=>{if($(id))$(id).innerHTML=rh;});
  }catch(e){}
}

/* ‚ïê‚ïê‚ïê LOGS ‚ïê‚ïê‚ïê */
async function loadLogs(){
  try{
    const logs=await(await fetch('/api/logs')).json();
    const lvl={ok:'ok',error:'error',info:'info'};
    const lbl={ok:'OK',error:'ERR',info:'INFO'};
    const h=logs.length?logs.map(l=>{const lv=lvl[l.level]||'info';return `<div class="log-row lv-${l.level}"><span class="log-ts">${l.t}</span><span class="log-lv ${lv}">${lbl[lv]||'INFO'}</span><span class="log-ph">${l.phase}</span><span class="log-msg${l.level==='error'?' lv-error':''}">${l.msg}</span></div>`;}).join('')+'<div class="log-row" style="border-top:1px solid var(--bd2);margin-top:6px"><span class="log-ts" style="color:rgba(255,255,255,.05)">[--:--]</span><span style="color:var(--amb);font-weight:700;letter-spacing:2px;font-size:.85em;display:flex;align-items:center;gap:6px"><span style="display:inline-block;width:5px;height:5px;background:var(--amb);border-radius:50%;animation:pulse 1.5s infinite"></span>LISTENING...</span></div>':'<div class="log-row"><span class="log-msg" style="color:var(--txtd)">No events captured.</span></div>';
    ['d-la','m-la'].forEach(id=>{if($(id))$(id).innerHTML=h;});
    if($('d-lc'))$('d-lc').textContent=logs.length+' entries';
  }catch(e){}
}

/* ‚ïê‚ïê‚ïê PREVIEW ‚ïê‚ïê‚ïê */
async function rPv(){
  try{
    const r=await(await fetch('/api/last-result')).json();
    if(!r||!r.topic)return;
    ['d-','m-'].forEach(px=>{
      if($(px+'pve'))$(px+'pve').style.display='none';
      if(r.images&&r.images.length){if($(px+'pvi'))$(px+'pvi').style.display='block';if($(px+'pig'))$(px+'pig').innerHTML=r.images.map(img=>`<div class="pcard"><img src="${img.url}" alt="S${img.index}" loading="lazy"><div class="plbl">SCENE ${img.index}</div><a class="dl" href="${img.url}" download target="_blank">‚¨á</a></div>`).join('');}
      if(r.videos&&r.videos.length){if($(px+'pvv'))$(px+'pvv').style.display='block';if($(px+'pvg'))$(px+'pvg').innerHTML=r.videos.map(v=>`<div class="pcard"><video src="${v.url}" muted loop playsinline onmouseenter="this.play()" onmouseleave="this.pause();this.currentTime=0"></video><div class="plbl">CLIP ${v.index}</div><a class="dl" href="${v.url}" download target="_blank">‚¨á</a></div>`).join('');}
      if(r.final_video){if($(px+'pvf'))$(px+'pvf').style.display='block';if($(px+'fv'))$(px+'fv').src=r.final_video;if($(px+'fd'))$(px+'fd').href=r.final_video;}
      if(r.script){if($(px+'pvs'))$(px+'pvs').style.display='block';if($(px+'pst'))$(px+'pst').textContent=typeof r.script==='string'?r.script:(r.script.script_full||'');}
    });
  }catch(e){}
}

/* ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê */
function getModels(fk){const prov=fk==='image_model'?(ST.image_provider||'replicate'):(ST.video_provider||'replicate');const cat=fk==='image_model'?IMG_MODELS:VID_MODELS;return cat[prov]||[];}

function rSt(){
  let h='';
  STS.forEach((sec,si)=>{
    let ff='';
    sec.f.forEach(f=>{try{
      const v=ST[f.k]!==undefined?ST[f.k]:f.d;
      if(f.tp==='toggle'){
        const on=v===true||v==='true';
        ff+=`<div class="fi w" style="display:flex;align-items:center;justify-content:space-between"><div style="font-size:.9em;color:var(--wht)">${f.l}</div><button class="tg ${on?'on':'off'}" onclick="event.stopPropagation();ST['${f.k}']=!(ST['${f.k}']===true||ST['${f.k}']==='true');rSt()"><span class="td"></span></button></div>`;
      }else if(f.tp==='select'){
        let opts=f.o;
        if(f.dynamic&&SCENE_DATA){
          // Build options from brand scene data
          opts=["auto"];
          if(f.dynamic==='stories'&&SCENE_DATA.stories){
            SCENE_DATA.stories.forEach(s=>opts.push(s.name+' ‚Äî '+s.mood));
          }else if(f.dynamic==='themes'&&SCENE_DATA.themes){
            Object.keys(SCENE_DATA.themes).forEach(t=>opts.push(t));
          }else if(f.dynamic==='figures'&&SCENE_DATA.figures){
            SCENE_DATA.figures.forEach((fig,i)=>opts.push(fig.substring(0,60)));
          }else if(f.dynamic==='moods'&&SCENE_DATA.moods){
            Object.keys(SCENE_DATA.moods).forEach(m=>opts.push(m));
          }
          ff+=`<div class="fi"><div class="fl">${f.l}</div><select class="fin" onchange="ST['${f.k}']=this.value">${opts.map(o=>`<option${o==v?' selected':''}>${o}</option>`).join('')}</select></div>`;
        }else if(f.dep){
          opts=getModels(f.k);
          ff+=`<div class="fi"><div class="fl">${f.l}</div><select class="fin" onchange="ST['${f.k}']=this.value">${opts.map(o=>`<option value="${o.v}"${o.v==v?' selected':''}>${o.l}</option>`).join('')}</select></div>`;
        }else if(f.k==='image_provider'||f.k==='video_provider'||f.k==='clip_count'||f.k==='clip_duration'){
          ff+=`<div class="fi"><div class="fl">${f.l}</div><select class="fin" onchange="ST['${f.k}']=this.value;rSt()">${opts.map(o=>`<option${o==v?' selected':''}>${o}</option>`).join('')}</select></div>`;
        }else{
          ff+=`<div class="fi"><div class="fl">${f.l}</div><select class="fin" onchange="ST['${f.k}']=this.value">${opts.map(o=>`<option${o==v?' selected':''}>${o}</option>`).join('')}</select></div>`;
        }
      }else if(f.tp==='computed'){
        const clips=parseInt(ST.clip_count)||3,dur=parseInt(ST.clip_duration)||10,clipTot=clips*dur;
        const words=parseInt(ST.script_words)||90,voEst=Math.round(words/3);
        const ctaOn=ST.cta_enabled===true||ST.cta_enabled==='true';
        const ctaDur=ctaOn?parseFloat(ST.cta_duration||4):0;
        const finalDur=Math.max(voEst,clipTot)+ctaDur+1;
        const overflow=voEst-clipTot;
        let status,sc;
        if(overflow>dur){status='‚ö† Voice overflows clips by '+overflow+'s ‚Äî consider adding a clip';sc='var(--red)';}
        else if(overflow>3){status='‚ö† CTA will stretch ~'+overflow+'s to cover voice';sc='var(--amb)';}
        else if(overflow<-10){status='‚Ñπ Clips extend '+Math.abs(overflow)+'s past voice ‚Äî last frame holds';sc='var(--amb)';}
        else{status='‚úì Well matched';sc='var(--grn)';}
        ff+=`<div class="fi w" style="border:1px solid var(--bd2);padding:10px;background:rgba(227,160,40,.03)">
<div style="font-family:var(--f1);font-size:.6em;letter-spacing:.15em;color:var(--txtd);margin-bottom:6px">TIMING BREAKDOWN</div>
<div style="display:flex;gap:8px;margin-bottom:6px">
<div style="flex:1;padding:5px;background:var(--bg);border:1px solid var(--bd2);text-align:center"><div style="font-family:var(--f1);font-size:.9em;font-weight:800;color:var(--amb)">${clipTot}s</div><div style="font-size:.5em;color:var(--txtdd);letter-spacing:.1em">CLIPS ${clips}√ó${dur}s</div></div>
<div style="flex:1;padding:5px;background:var(--bg);border:1px solid var(--bd2);text-align:center"><div style="font-family:var(--f1);font-size:.9em;font-weight:800;color:var(--blu)">${voEst}s</div><div style="font-size:.5em;color:var(--txtdd);letter-spacing:.1em">VOICE ~${words}w</div></div>
${ctaDur>0?`<div style="flex:1;padding:5px;background:var(--bg);border:1px solid var(--bd2);text-align:center"><div style="font-family:var(--f1);font-size:.9em;font-weight:800;color:var(--txtd)">${ctaDur}s</div><div style="font-size:.5em;color:var(--txtdd);letter-spacing:.1em">CTA</div></div>`:''}
<div style="flex:1;padding:5px;background:var(--bg);border:1px solid var(--grn);text-align:center"><div style="font-family:var(--f1);font-size:.9em;font-weight:800;color:var(--grn)">~${Math.round(finalDur)}s</div><div style="font-size:.5em;color:var(--txtdd);letter-spacing:.1em">FINAL</div></div>
</div>
<div style="font-size:.55em;color:${sc}">${status}</div>
<div style="font-size:.45em;color:var(--txtdd);margin-top:3px">Voice dictates length. Clips play naturally, CTA stretches if needed.</div>
</div>`;
      }else if(f.tp==='slider'){
        const mn=f.min||30,mx=f.max||180,stp=f.step||5,cv=parseInt(v)||f.d,secs=Math.round(cv/3),pct=((cv-mn)/(mx-mn))*100;
        ff+=`<div class="fi w"><div class="fl">${f.l}</div><div style="display:flex;align-items:center;gap:.55em"><input type="range" min="${mn}" max="${mx}" step="${stp}" value="${cv}" class="fin-slider" style="flex:1" oninput="ST['${f.k}']=parseInt(this.value);document.getElementById('sl_${f.k}').textContent=this.value+' words ‚âà '+Math.round(this.value/3)+'s'" onchange="ST['${f.k}']=parseInt(this.value);document.getElementById('sl_${f.k}').textContent=this.value+' words ‚âà '+Math.round(this.value/3)+'s'" ontouchmove="ST['${f.k}']=parseInt(this.value);document.getElementById('sl_${f.k}').textContent=this.value+' words ‚âà '+Math.round(this.value/3)+'s'"><div id="sl_${f.k}" style="min-width:6em;font-family:var(--f1);font-size:.65em;letter-spacing:1px;color:var(--amb);text-align:right">${cv} words ‚âà ${secs}s</div></div></div>`;
      }else if(f.tp==='scene_pack'){
        const src=SCENE_DATA?'Brand':'Default (Knights)';
        const sc=SCENE_DATA&&SCENE_DATA._source==='brand'?'var(--grn)':'var(--txtd)';
        const nStories=SCENE_DATA?SCENE_DATA.stories.length:0;
        const nFigs=SCENE_DATA?SCENE_DATA.figures.length:0;
        const nMoods=SCENE_DATA?Object.keys(SCENE_DATA.moods).length:0;
        ff+=`<div class="fi w" style="border:1px solid var(--bd2);padding:10px;background:rgba(227,160,40,.03)">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<div style="font-family:var(--f1);font-size:.6em;letter-spacing:.15em;color:var(--txtd)">SCENE PACK</div>
<span style="font-size:.55em;color:${sc};letter-spacing:.08em">${src.toUpperCase()}</span>
</div>
<div style="display:flex;gap:6px;margin-bottom:8px">
<div style="flex:1;padding:4px;background:var(--bg);border:1px solid var(--bd2);text-align:center"><div style="font-family:var(--f1);font-size:.85em;font-weight:800;color:var(--amb)">${nStories}</div><div style="font-size:.45em;color:var(--txtdd);letter-spacing:.08em">STORIES</div></div>
<div style="flex:1;padding:4px;background:var(--bg);border:1px solid var(--bd2);text-align:center"><div style="font-family:var(--f1);font-size:.85em;font-weight:800;color:var(--amb)">${nFigs}</div><div style="font-size:.45em;color:var(--txtdd);letter-spacing:.08em">FIGURES</div></div>
<div style="flex:1;padding:4px;background:var(--bg);border:1px solid var(--bd2);text-align:center"><div style="font-family:var(--f1);font-size:.85em;font-weight:800;color:var(--amb)">${nMoods}</div><div style="font-size:.45em;color:var(--txtdd);letter-spacing:.08em">MOODS</div></div>
</div>
<div style="display:flex;gap:6px">
<button style="flex:1;padding:6px;background:var(--bg);border:1px solid var(--bd2);color:var(--amb);font-size:.6em;font-family:var(--f1);letter-spacing:.1em;cursor:pointer" onclick="editScenePack()">‚úé EDIT JSON</button>
<button style="flex:1;padding:6px;background:var(--bg);border:1px solid var(--bd2);color:var(--txtd);font-size:.6em;font-family:var(--f1);letter-spacing:.1em;cursor:pointer" onclick="seedDefaults()">‚¨á SEED DEFAULTS</button>
</div>
</div>`;
      }else if(f.tp==='textarea'){
        ff+=`<div class="fi w"><div class="fl">${f.l}</div><textarea class="fin" rows="3" style="resize:vertical;min-height:3em" onchange="ST['${f.k}']=this.value">${v||''}</textarea></div>`;
      }else{
        ff+=`<div class="fi"><div class="fl">${f.l}</div><input class="fin" value="${v||''}" onchange="ST['${f.k}']=this.value"></div>`;
      }
    }catch(e){console.error('CFG:',f.k,e);}});
    h+=`<div class="sec"><button class="sec-h" onclick="stOpen[${si}]=!stOpen[${si}];rSt()"><span class="sec-t">${sec.t}</span><span class="sec-a" style="transform:${stOpen[si]?'rotate(90deg)':''}">‚Ä∫</span></button><div class="sec-b${stOpen[si]?'':' shut'}">${ff}</div></div>`;
  });
  ['d-sf','m-sf'].forEach(id=>{if($(id))$(id).innerHTML=h;});
}

async function saveSett(){
  await fetch('/api/settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(ST)});
  ['d-ss','m-ss'].forEach(id=>{if($(id)){$(id).style.display='block';setTimeout(()=>$(id).style.display='none',3000);}});
}

/* ‚ïê‚ïê‚ïê HEALTH ‚ïê‚ïê‚ïê */
async function rH(){
  try{
    const cfg=await(await fetch('/api/config')).json();
    const h='<div class="rw"><span style="font-family:var(--f1);font-size:.6em;color:var(--txtd);letter-spacing:.2em">API CONNECTIONS</span></div>'+SVCS.map(s=>`<div class="rw" style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-family:var(--f1);font-size:.7em;font-weight:600;letter-spacing:.15em;color:var(--wht)">${s.n}</div><div style="font-size:.55em;color:var(--txtd);margin-top:.05em">${s.d}</div></div>${B(cfg[s.k]?'configured':'missing')}</div>`).join('');
    ['d-hl','m-hl'].forEach(id=>{if($(id))$(id).innerHTML=h;});
  }catch(e){}
}
async function testAll(){
  alert('Testing connections...');
  for(const s of['openai','replicate','elevenlabs']){
    try{await(await fetch('/api/test-connection',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({service:s})})).json();}catch(e){}
  }
  rH();alert('Done!');
}

/* ‚ïê‚ïê‚ïê SCENE PACK ‚ïê‚ïê‚ïê */
async function loadSceneData(){
  try{
    const r=await(await fetch('/api/scenes')).json();
    SCENE_DATA=r.data||null;
    if(SCENE_DATA)SCENE_DATA._source=r.source;
  }catch(e){SCENE_DATA=null;}
}

async function seedDefaults(){
  if(!confirm('Copy knight default scenes into this brand? This will overwrite any existing brand scenes.'))return;
  try{
    await fetch('/api/scenes/seed-defaults',{method:'POST'});
    await loadSceneData();
    rSt();
    alert('Knight defaults seeded into this brand. You can now edit them.');
  }catch(e){alert('Failed: '+e);}
}

function editScenePack(){
  // Open scene JSON editor in a modal-style overlay
  const json=JSON.stringify(SCENE_DATA||{},null,2);
  const el=document.createElement('div');
  el.id='scene-editor-overlay';
  el.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);z-index:9999;display:flex;flex-direction:column;padding:12px';
  el.innerHTML=`
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<span style="font-family:var(--f1);font-size:.7em;color:var(--amb);letter-spacing:.15em">SCENE PACK EDITOR</span>
<div style="display:flex;gap:6px">
<button onclick="saveScenePack()" style="padding:6px 14px;background:var(--amb);color:var(--bg);border:none;font-family:var(--f1);font-size:.6em;letter-spacing:.15em;cursor:pointer">SAVE</button>
<button onclick="document.getElementById('scene-editor-overlay').remove()" style="padding:6px 14px;background:var(--bg3);color:var(--red);border:1px solid rgba(224,64,40,.2);font-family:var(--f1);font-size:.6em;letter-spacing:.15em;cursor:pointer">CLOSE</button>
</div>
</div>
<div style="font-size:.55em;color:var(--txtd);margin-bottom:8px">Edit figures, stories, themes, moods. Each story needs: name, themes[], mood, clips[] with 8 fields each.</div>
<textarea id="scene-json-editor" style="flex:1;width:100%;background:var(--bg);color:var(--amb);border:1px solid var(--bd);font-family:var(--f3);font-size:.75em;padding:10px;resize:none;outline:none;tab-size:2">${escHtml(json)}</textarea>
<div id="scene-editor-status" style="font-size:.6em;color:var(--txtd);margin-top:6px"></div>`;
  document.body.appendChild(el);
  // Tab key support in textarea
  const ta=document.getElementById('scene-json-editor');
  ta.addEventListener('keydown',function(e){
    if(e.key==='Tab'){e.preventDefault();const s=this.selectionStart,end=this.selectionEnd;this.value=this.value.substring(0,s)+'  '+this.value.substring(end);this.selectionStart=this.selectionEnd=s+2;}
  });
}

function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

async function saveScenePack(){
  const ta=document.getElementById('scene-json-editor');
  const st=document.getElementById('scene-editor-status');
  let data;
  try{data=JSON.parse(ta.value);}catch(e){st.style.color='var(--red)';st.textContent='Invalid JSON: '+e.message;return;}
  // Validate structure
  if(!data.stories||!Array.isArray(data.stories)){st.style.color='var(--red)';st.textContent='Missing "stories" array';return;}
  if(!data.figures||!Array.isArray(data.figures)){st.style.color='var(--red)';st.textContent='Missing "figures" array';return;}
  try{
    await fetch('/api/scenes',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    st.style.color='var(--grn)';st.textContent='‚úì Saved ‚Äî '+data.stories.length+' stories, '+data.figures.length+' figures';
    await loadSceneData();
    rSt();
  }catch(e){st.style.color='var(--red)';st.textContent='Save failed: '+e;}
}

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
/* BRANDS */
let BRANDS=[],ACTIVE_BRAND='knights';
async function loadBrands(){
  try{
    const r=await(await fetch('/api/brands')).json();
    BRANDS=r.brands||[];ACTIVE_BRAND=r.active||'knights';
    ['d-brand-sel','m-brand-sel'].forEach(id=>{
      const sel=$(id);if(!sel)return;
      sel.innerHTML=BRANDS.map(b=>`<option value="${b.id}"${b.id===ACTIVE_BRAND?' selected':''}>${b.display_name}</option>`).join('')
        +`<option value="__new__">+ New Brand...</option>`;
    });
    const ab=BRANDS.find(b=>b.id===ACTIVE_BRAND);
    const dn=ab?ab.display_name:'CONTENT REACTOR';
    const parts=dn.toUpperCase().split(' ');
    if($('d-brand-title'))$('d-brand-title').innerHTML=parts.length>1?parts.slice(0,-1).join(' ')+'<br>'+parts[parts.length-1]:dn;
    if($('m-brand-title'))$('m-brand-title').textContent=dn.toUpperCase();
    // Show delete button only for non-default brands
    const canDel=ACTIVE_BRAND!=='knights';
    ['d-brand-del','m-brand-del'].forEach(id=>{if($(id))$(id).style.display=canDel?'block':'none';});
  }catch(e){console.error('loadBrands:',e);}
}
async function deleteBrand(){
  if(ACTIVE_BRAND==='knights'){alert('Cannot delete the default brand.');return;}
  const ab=BRANDS.find(b=>b.id===ACTIVE_BRAND);
  const name=ab?ab.display_name:ACTIVE_BRAND;
  const toDelete=ACTIVE_BRAND;
  if(!confirm(`Delete brand "${name}"?\n\nThis removes all settings, runs, and scene data for this brand. This cannot be undone.`))return;
  // Switch to knights first (backend won't delete active brand)
  await fetch('/api/brands/switch',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({brand:'knights'})});
  // Now delete
  const r=await fetch('/api/brands/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({brand:toDelete})});
  const d=await r.json();
  if(!r.ok){alert(d.error||'Delete failed');return;}
  await loadBrands();await init();loadTopics();loadRuns();
}
async function switchBrand(val){
  let isNew=false;
  if(val==='__new__'){
    const name=prompt('New brand name:');
    if(!name){loadBrands();return;}
    const r=await fetch('/api/brands/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,display_name:name})});
    const d=await r.json();
    if(!r.ok){alert(d.error||'Failed');loadBrands();return;}
    val=d.brand;isNew=true;
  }
  await fetch('/api/brands/switch',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({brand:val})});
  await loadBrands();
  await init();
  // Blank brand-specific fields for NEW brands so user knows what to fill in
  if(isNew){STS.forEach(s=>s.f.forEach(f=>{if(f.b)ST[f.k]=f.k==='brand_name'?val.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()):''}));rSt();}
  loadTopics();
  loadRuns();
}

// ‚îÄ‚îÄ‚îÄ CHANNELS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CH_FIELDS=['instagram','facebook','facebook-page','twitter','threads','tiktok','youtube','pinterest','pinterest-board'];
async function loadChannels(){
  try{
    const r=await(await fetch('/api/channels')).json();
    CH_FIELDS.forEach(k=>{
      const val=r[k.replace(/-/g,'_')]||'';
      const d=$('ch-'+k);if(d)d.value=val;
      const m=$('mch-'+k);if(m)m.value=val;
    });
    ['ch-status','mch-status'].forEach(id=>{if($(id))$(id).innerHTML='<span style="color:var(--grn)">‚úì Loaded</span>';});
  }catch(e){['ch-status','mch-status'].forEach(id=>{if($(id))$(id).innerHTML=`<span style="color:var(--red)">Error: ${e}</span>`;});}
}
async function saveChannels(){
  const body={};
  CH_FIELDS.forEach(k=>{
    const d=$('ch-'+k);const m=$('mch-'+k);
    body[k.replace(/-/g,'_')]=(d&&d.value?d.value:m&&m.value?m.value:'').trim();
  });
  try{
    await fetch('/api/channels',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    ['ch-status','mch-status'].forEach(id=>{if($(id))$(id).innerHTML='<span style="color:var(--grn)">‚úì Channels saved!</span>';});
  }catch(e){['ch-status','mch-status'].forEach(id=>{if($(id))$(id).innerHTML=`<span style="color:var(--red)">Error: ${e}</span>`;});}
}

async function init(){
  rP();updThemeBtn();
  await loadBrands();
  ['d','m'].forEach(px=>renderManualCards(px)); // Init manual clip cards
  try{
    const r=await(await fetch('/api/settings')).json();
    STS.forEach(s=>s.f.forEach(f=>{if(r[f.k]!==undefined)ST[f.k]=r[f.k];else ST[f.k]=f.d;}));
  }catch(e){STS.forEach(s=>s.f.forEach(f=>ST[f.k]=f.d));}
  await loadSceneData();
  rSt();
  try{
    const r=await(await fetch('/api/status')).json();
    if(r.result){
      LAST_RESULT=r.result;
      GATE=r.result.gate||null;
      PD=r.phases_done||[];
    }
    if(r.running){RN=true;PH=r.phase;PD=r.phases_done||[];rP();poll();}
    else{rP();}
  }catch(e){}
}
autoLogin();
</script></body></html>
